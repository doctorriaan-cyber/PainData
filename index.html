<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pain Data Manager</title>
    <meta name="description" content="An application to import, view, edit, and export patient data from an XLSX file, designed for mobile use." />
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiUGFpbiBEYXRhIE1hbmFnZXIiLCJzaG9ydF9uYW1lIjoiUGFpbiBEYXRhIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMxMTE4MjciLCJ0aGVtZV9jb2xvciI6IiM0ZjQ2ZTUiLCJkZXNjcmlwdGlvbiI6IkFuIGFwcGxpY2F0aW9uIHRvIGltcG9ydCwgdmlldywgZWRpdCwgYW5kIGV4cG9ydCBwYXRpZW50IGRhdGEuIiwiaWNvbnMiOlt7InNyYyI6ImNyb3BwZWQucG5nIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3BuZyIsInB1cnBvc2UiOiJhbnkgbWFza2FibGUifV19" />
    <meta name="theme-color" content="#111827" />
    <link rel="apple-touch-icon" href="cropped.png" />
    
    <!-- CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        // --- From components/icons.tsx ---
        const UploadIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path d="M5.5 13a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.977A4.5 4.5 0 1113.5 13H11V9.414l-1.293 1.293a1 1 0 01-1.414-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 9.414V13H5.5z" />
                <path d="M9 13h2v5H9v-5z" />
            </svg>
        );

        const DownloadIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 9.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 7.414V13a1 1 0 11-2 0V7.414L6.293 9.707z" clipRule="evenodd" />
            </svg>
        );

        const InstallIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" className="w-5 h-5">
              <path d="M10.75 2.75a.75.75 0 0 0-1.5 0v8.614L6.295 8.235a.75.75 0 1 0-1.09 1.03l4.25 4.5a.75.75 0 0 0 1.09 0l4.25-4.5a.75.75 0 0 0-1.09-1.03l-2.955 3.129V2.75Z" />
              <path d="M3.5 12.75a.75.75 0 0 0-1.5 0v2.5A2.75 2.75 0 0 0 4.75 18h10.5A2.75 2.75 0 0 0 18 15.25v-2.5a.75.75 0 0 0-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5Z" />
            </svg>
        );

        const ChevronDownIcon = ({ isOpen }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={`h-6 w-6 transform transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
            </svg>
        );

        const CloseIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
        );

        const TrashIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" />
            </svg>
        );

        const WarningIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-12 w-12 text-yellow-400 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
        );

        // --- From services/xlsxService.ts ---
        const getCellValue = (worksheet, address) => {
          const cell = worksheet[address];
          if (!cell) return '';

          if (cell.t === 'd' && cell.v instanceof Date) {
            const date = cell.v;
            if (!isNaN(date.getTime())) {
              const hours = String(date.getHours()).padStart(2, '0');
              const minutes = String(date.getMinutes()).padStart(2, '0');
              return `${hours}:${minutes}`;
            }
          }

          if (cell.w) {
            return cell.w;
          }
          
          return cell.v !== null && cell.v !== undefined ? String(cell.v) : '';
        };

        const parsePatientData = async (file) => {
          const data = await file.arrayBuffer();
          const workbook = XLSX.read(data, { cellDates: true });
          const worksheet = workbook.Sheets[workbook.SheetNames[0]];

          const p2RawValue = getCellValue(worksheet, 'P2') || '';
          const p2Part = p2RawValue.split(',')[0].trim();

          const p4RawValue = getCellValue(worksheet, 'P4') || '';
          const p4Part = p4RawValue.split(' ')[0].trim();
          
          const sectionHeader = [p2Part, p4Part].filter(Boolean).join(', ');
          
          const patients = [];
          let patientIndex = 0;
          
          while (true) {
            const startRow = patientIndex * 12 + 1;
            const nameCellAddress = `M${startRow}`;
            const patientName = getCellValue(worksheet, nameCellAddress);

            if (!patientName) {
              break;
            }

            const notes = [];
            for (let i = 0; i < 7; i++) {
                notes.push(getCellValue(worksheet, `M${startRow + 1 + i}`));
            }
            
            const patient = {
              id: `${file.name}-${patientIndex}`,
              name: patientName,
              age: getCellValue(worksheet, `N${startRow}`),
              procedure: getCellValue(worksheet, `M${startRow + 8}`),
              inTime: getCellValue(worksheet, `K${startRow + 3}`),
              outTime: getCellValue(worksheet, `K${startRow + 4}`),
              weight: getCellValue(worksheet, `K${startRow + 5}`),
              height: getCellValue(worksheet, `K${startRow + 6}`),
              sedationType: getCellValue(worksheet, `K${startRow + 7}`),
              tci: getCellValue(worksheet, `K${startRow + 8}`),
              notes: notes,
              ketamineAmount: getCellValue(worksheet, `N${startRow + 10}`),
              originalRow: startRow,
            };
            
            patients.push(patient);
            patientIndex++;
          }
          
          return { sectionHeader, patients };
        };

        const exportPatientData = (patients, fileName = 'pain_data_export.xlsx') => {
            const wb = XLSX.utils.book_new();
            const ws = {};

            patients.forEach(patient => {
                const r = patient.originalRow;
                
                const addCell = (address, value) => {
                    if (value === null || value === undefined || value === '') return;
                    const cell = { t: 's', v: String(value) };
                    ws[address] = cell;
                };

                addCell(`M${r}`, patient.name);
                addCell(`N${r}`, patient.age);
                addCell(`K${r + 3}`, patient.inTime);
                addCell(`K${r + 4}`, patient.outTime);
                addCell(`K${r + 5}`, patient.weight);
                addCell(`K${r + 6}`, patient.height);
                addCell(`K${r + 7}`, patient.sedationType);
                addCell(`K${r + 8}`, patient.tci);
                addCell(`M${r + 8}`, patient.procedure);
                addCell(`N${r + 10}`, patient.ketamineAmount);

                patient.notes.forEach((note, index) => {
                    addCell(`M${r + 1 + index}`, note);
                });
            });

            if (Object.keys(ws).length > 0) {
                const range = { s: { c: 10000, r: 10000 }, e: { c: 0, r: 0 } };
                Object.keys(ws).forEach(address => {
                    if (address === '!ref') return;
                    const cellRef = XLSX.utils.decode_cell(address);
                    range.s.c = Math.min(range.s.c, cellRef.c);
                    range.s.r = Math.min(range.s.r, cellRef.r);
                    range.e.c = Math.max(range.e.c, cellRef.c);
                    range.e.r = Math.max(range.e.r, cellRef.r);
                });
                ws['!ref'] = XLSX.utils.encode_range(range);
            } else {
                ws['!ref'] = 'A1';
            }
            
            XLSX.utils.book_append_sheet(wb, ws, "Patient Data");
            XLSX.writeFile(wb, fileName);
        };

        // --- From components/ConfirmModal.tsx ---
        const ConfirmModal = ({ title, message, onConfirm, onClose }) => {
            return (
                <div 
                    className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50"
                    aria-modal="true"
                    role="dialog"
                    onClick={onClose}
                >
                    <div 
                        className="bg-gray-800 rounded-lg shadow-2xl w-full max-w-sm border border-gray-700 text-center"
                        onClick={(e) => e.stopPropagation()}
                    >
                        <div className="p-6">
                            <WarningIcon />
                            <h2 className="text-xl font-bold text-red-400 mb-2">{title}</h2>
                            <p className="text-gray-300">{message}</p>
                        </div>
                        <div className="p-4 bg-gray-900/50 flex justify-center space-x-4 rounded-b-lg">
                             <button
                                onClick={onClose}
                                className="px-6 py-2 bg-gray-600 hover:bg-gray-500 text-white font-semibold rounded-lg w-full"
                            >
                                Cancel
                            </button>
                            <button
                                onClick={onConfirm}
                                className="px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg w-full"
                            >
                                Confirm
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- From components/ExportModal.tsx ---
        const ExportModal = ({ sections, onSelect, onClose }) => {
            return (
                <div 
                    className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50"
                    aria-modal="true"
                    role="dialog"
                    onClick={onClose}
                >
                    <div 
                        className="bg-gray-800 rounded-lg shadow-2xl w-full max-w-sm border border-gray-700"
                        onClick={(e) => e.stopPropagation()}
                    >
                        <div className="flex justify-between items-center p-4 border-b border-gray-600">
                            <h2 className="text-xl font-bold text-indigo-300">Select Section to Export</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-white">
                                <CloseIcon />
                            </button>
                        </div>
                        <div className="p-4 max-h-80 overflow-y-auto">
                            <p className="text-gray-300 mb-4">Choose which imported file you would like to export.</p>
                            <div className="space-y-3">
                                {sections.map((section, index) => (
                                    <button
                                        key={`${section.sectionHeader}-${index}`}
                                        onClick={() => onSelect(section)}
                                        className="w-full text-left px-4 py-3 bg-gray-700 hover:bg-indigo-600 rounded-md transition-colors duration-200"
                                    >
                                        {section.sectionHeader}
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div className="p-4 border-t border-gray-600 text-right">
                             <button
                                onClick={onClose}
                                className="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white font-semibold rounded-lg"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- From components/PatientAccordion.tsx ---
        const InputField = ({ label, name, value, onChange }) => (
            <div>
                <label htmlFor={name} className="block text-sm font-medium text-gray-300 mb-1">{label}</label>
                <input
                    type="text"
                    id={name}
                    name={name}
                    value={value}
                    onChange={onChange}
                    className="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                />
            </div>
        );

        const PatientAccordion = ({ patient, onUpdate }) => {
            const [isOpen, setIsOpen] = React.useState(false);

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                onUpdate({ ...patient, [name]: value });
            };

            const handleNoteChange = (index, value) => {
                const newNotes = [...patient.notes];
                newNotes[index] = value;
                onUpdate({ ...patient, notes: newNotes });
            };

            const isComplete = React.useMemo(() => {
                return !!(
                    patient.inTime &&
                    patient.outTime &&
                    patient.weight &&
                    patient.height &&
                    patient.tci
                );
            }, [patient.inTime, patient.outTime, patient.weight, patient.height, patient.tci]);

            const { name, age, bmi } = React.useMemo(() => {
                const weightNum = parseFloat(patient.weight);
                const heightNum = parseFloat(patient.height);
                let calculatedBmi = null;

                if (weightNum > 0 && heightNum > 0) {
                    const heightInMeters = heightNum; // Height is expected in meters
                    calculatedBmi = (weightNum / (heightInMeters * heightInMeters)).toFixed(1);
                }

                return {
                    name: patient.name || 'Unnamed Patient',
                    age: patient.age ? `Age: ${patient.age}` : '',
                    bmi: (calculatedBmi && !isNaN(calculatedBmi)) ? `BMI: ${calculatedBmi}` : '',
                };
            }, [patient.name, patient.age, patient.weight, patient.height]);

            return (
                <div className="bg-gray-800 rounded-lg shadow-lg overflow-hidden">
                    <button
                        onClick={() => setIsOpen(!isOpen)}
                        className="w-full flex justify-between items-center p-4 text-left hover:bg-gray-700 focus:outline-none focus:bg-gray-700"
                        aria-expanded={isOpen}
                    >
                        <div className="flex items-center min-w-0">
                             <span
                                className={`w-3 h-3 rounded-full mr-3 flex-shrink-0 self-start mt-2 ${isComplete ? 'bg-green-500' : 'bg-red-500'}`}
                                title={isComplete ? 'All fields complete' : 'Missing required data'}
                            ></span>
                            <div className="flex flex-col min-w-0">
                                <span className="truncate font-semibold text-lg text-indigo-300" title={name}>{name}</span>
                                {(age || bmi) && (
                                    <span className="text-sm text-gray-400">
                                        {age}{age && bmi ? ', ' : ''}{bmi}
                                    </span>
                                )}
                            </div>
                        </div>
                        <ChevronDownIcon isOpen={isOpen} />
                    </button>
                    <div className={`grid transition-all duration-500 ease-in-out ${isOpen ? 'grid-rows-[1fr]' : 'grid-rows-[0fr]'}`}>
                        <div className="overflow-hidden">
                            <div className="p-4 border-t border-gray-700 space-y-4">
                                {patient.procedure && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-300 mb-1">Procedure</label>
                                        <p className="w-full bg-gray-700/50 border border-gray-600 rounded-md px-3 py-2 text-gray-200 min-h-[42px]">
                                            {patient.procedure}
                                        </p>
                                    </div>
                                )}
                                <div className="grid grid-cols-2 gap-4">
                                    <InputField label="In Time" name="inTime" value={patient.inTime} onChange={handleInputChange} />
                                    <InputField label="Out Time" name="outTime" value={patient.outTime} onChange={handleInputChange} />
                                    <InputField label="Weight (kg)" name="weight" value={patient.weight} onChange={handleInputChange} />
                                    <InputField label="Height (m)" name="height" value={patient.height} onChange={handleInputChange} />
                                    <InputField label="TCI" name="tci" value={patient.tci} onChange={handleInputChange} />
                                    <InputField label="Ketamine Amount" name="ketamineAmount" value={patient.ketamineAmount} onChange={handleInputChange} />
                                    <div className="col-span-2">
                                        <div>
                                            <label htmlFor="sedationType" className="block text-sm font-medium text-gray-300 mb-1">Sedation Type</label>
                                            <select
                                                id="sedationType"
                                                name="sedationType"
                                                value={patient.sedationType}
                                                onChange={handleInputChange}
                                                className="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                            >
                                                <option value="Deep">Deep</option>
                                                <option value="Awake">Awake</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-300 mb-1">Patient Notes</label>
                                    <div className="space-y-2">
                                        {patient.notes.map((note, index) => (
                                            <textarea
                                                key={index}
                                                value={note}
                                                onChange={(e) => handleNoteChange(index, e.target.value)}
                                                placeholder={`Note ${index + 1}`}
                                                rows={1}
                                                className="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-y"
                                            />
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- From App.tsx ---
        const App = () => {
            const { useState, useRef, useCallback, useEffect } = React;
            const LOCAL_STORAGE_KEY = 'patientDataManagerData';

            const [allPatientData, setAllPatientData] = useState(() => {
                try {
                    const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                    return savedData ? JSON.parse(savedData) : [];
                } catch (error) {
                    console.error("Failed to load data from local storage", error);
                    return [];
                }
            });

            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);
            const [isExportModalOpen, setIsExportModalOpen] = useState(false);
            const [isConfirmModalOpen, setIsConfirmModalOpen] = useState(false);
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const fileInputRef = useRef(null);

            useEffect(() => {
                // Service Worker Registration
                if ('serviceWorker' in navigator) {
                    const swCode = `
                        const CACHE_NAME = 'pain-data-manager-cache-v1';
                        const urlsToCache = ['./', './index.html', './cropped.png'];

                        self.addEventListener('install', (event) => {
                            event.waitUntil(
                                caches.open(CACHE_NAME).then((cache) => {
                                    return cache.addAll(urlsToCache);
                                })
                            );
                        });

                        self.addEventListener('fetch', (event) => {
                            event.respondWith(
                                caches.match(event.request).then((response) => {
                                    return response || fetch(event.request);
                                })
                            );
                        });
                    `;
                    const blob = new Blob([swCode], { type: 'application/javascript' });
                    const swUrl = URL.createObjectURL(blob);

                    navigator.serviceWorker.register(swUrl)
                        .then((reg) => console.log('Service Worker registered.'))
                        .catch((err) => console.log('Service Worker registration failed:', err));
                }
                
                // Install prompt logic
                const handleBeforeInstallPrompt = (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                };

                window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);

                return () => {
                    window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
                };
            }, []);
            
            useEffect(() => {
                try {
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allPatientData));
                } catch (error) {
                    console.error("Failed to save data to local storage", error);
                    setError("Could not save data. Your browser's storage might be full.");
                }
            }, [allPatientData]);
            
            const handleInstallClick = async () => {
                if (!deferredPrompt) {
                    return;
                }
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                }
                setDeferredPrompt(null);
            };

            const handleFileImport = async (event) => {
                const file = event.target.files?.[0];
                if (!file) return;

                setIsLoading(true);
                setError(null);
                try {
                    const data = await parsePatientData(file);
                    if (data.patients.length === 0) {
                      setError("No patient data found in the file. Please check the format.");
                    } else {
                      setAllPatientData(prevData => [...prevData, data]);
                    }
                } catch (err) {
                    console.error(err);
                    setError('Failed to parse the file. Please ensure it is a valid XLSX file with the correct format.');
                } finally {
                    setIsLoading(false);
                    if (fileInputRef.current) {
                        fileInputRef.current.value = '';
                    }
                }
            };

            const performExport = (section) => {
                const headerPart = section.sectionHeader.split(',')[0].trim();
                const fileName = `${headerPart || 'pain_data'}.xlsx`;
                try {
                    exportPatientData(section.patients, fileName);
                } catch (err) {
                    console.error(err);
                    setError('Failed to export data.');
                }
            };

            const handleExport = () => {
                if (!allPatientData || allPatientData.length === 0) {
                    alert('No patient data to export.');
                    return;
                }
                
                if (allPatientData.length === 1) {
                    performExport(allPatientData[0]);
                } else {
                    setIsExportModalOpen(true);
                }
            };
            
            const handleSelectAndExport = (section) => {
                performExport(section);
                setIsExportModalOpen(false);
            };

            const handlePatientUpdate = useCallback((updatedPatient) => {
                setAllPatientData(currentAllData =>
                    currentAllData.map(section => ({
                        ...section,
                        patients: section.patients.map(p =>
                            p.id === updatedPatient.id ? updatedPatient : p
                        ),
                    }))
                );
            }, []);

            const handleClearAll = () => {
                setIsConfirmModalOpen(true);
            };

            const performClearAll = () => {
                setAllPatientData([]);
                setIsConfirmModalOpen(false);
            };
            
            const triggerFileInput = () => {
                fileInputRef.current?.click();
            };

            return (
                <div className="min-h-screen bg-gray-900 text-white font-sans">
                    <div className="max-w-md mx-auto p-4">
                        <header className="py-4">
                            <h1 className="text-3xl font-bold text-center text-indigo-400 mb-4">Pain Data Manager</h1>
                            <div className="flex justify-center space-x-2 flex-wrap gap-2">
                                <button
                                    onClick={triggerFileInput}
                                    className="flex items-center justify-center px-4 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow-md transition-transform transform hover:scale-105"
                                    aria-label="Import XLSX file"
                                >
                                    <UploadIcon />
                                    <span className="ml-2 hidden sm:inline">Import</span>
                                </button>
                                <input
                                    type="file"
                                    ref={fileInputRef}
                                    onChange={handleFileImport}
                                    className="hidden"
                                    accept=".xlsx"
                                />
                                <button
                                    onClick={handleExport}
                                    disabled={allPatientData.length === 0}
                                    className="flex items-center justify-center px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow-md transition-transform transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed disabled:transform-none"
                                    aria-label="Export data to XLSX file"
                                >
                                    <DownloadIcon />
                                    <span className="ml-2 hidden sm:inline">Export</span>
                                </button>
                                <button
                                    onClick={handleClearAll}
                                    disabled={allPatientData.length === 0}
                                    className="flex items-center justify-center px-4 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg shadow-md transition-transform transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed disabled:transform-none"
                                    aria-label="Clear all data"
                                >
                                    <TrashIcon />
                                    <span className="ml-2 hidden sm:inline">Clear All</span>
                                </button>
                                {deferredPrompt && (
                                    <button
                                        onClick={handleInstallClick}
                                        className="flex items-center justify-center px-4 py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg shadow-md transition-transform transform hover:scale-105"
                                        aria-label="Install application"
                                    >
                                        <InstallIcon />
                                        <span className="ml-2 hidden sm:inline">Install App</span>
                                    </button>
                                )}
                            </div>
                        </header>

                        <main className="mt-6 space-y-6">
                            {isLoading && <p className="text-center text-lg text-blue-400">Processing file...</p>}
                            {error && <p className="text-center text-lg text-red-400 bg-red-900/50 p-3 rounded-lg">{error}</p>}
                            
                            {!isLoading && allPatientData.length === 0 && !error && (
                                <div className="text-center text-gray-400 mt-16 p-6 bg-gray-800 rounded-lg">
                                    <p className="text-xl">Welcome!</p>
                                    <p>Click "Import" to load patient data.</p>
                                </div>
                            )}

                            {allPatientData.map((patientData, index) => (
                                patientData.patients.length > 0 && (
                                    <div key={`${patientData.sectionHeader}-${index}`} className="bg-black/20 rounded-lg shadow-lg overflow-hidden border border-gray-700">
                                         <h2 className="p-4 text-xl font-bold text-center text-indigo-300 bg-gray-800">
                                            {patientData.sectionHeader}
                                         </h2>
                                        <div className="p-4 space-y-3">
                                            {patientData.patients.map((patient) => (
                                                <PatientAccordion
                                                    key={patient.id}
                                                    patient={patient}
                                                    onUpdate={handlePatientUpdate}
                                                />
                                            ))}
                                        </div>
                                    </div>
                                )
                            ))}
                        </main>
                    </div>
                    {isExportModalOpen && (
                        <ExportModal
                            sections={allPatientData}
                            onSelect={handleSelectAndExport}
                            onClose={() => setIsExportModalOpen(false)}
                        />
                    )}
                    {isConfirmModalOpen && (
                        <ConfirmModal
                            title="Confirm Clear All"
                            message="Are you sure you want to delete all patient data? This action cannot be undone."
                            onConfirm={performClearAll}
                            onClose={() => setIsConfirmModalOpen(false)}
                        />
                    )}
                </div>
            );
        };

        // --- From index.tsx ---
        const rootElement = document.getElementById('root');
        if (!rootElement) {
          throw new Error("Could not find root element to mount to");
        }

        const root = ReactDOM.createRoot(rootElement);
        root.render(
          <React.StrictMode>
            <App />
          </React.StrictMode>
        );
    </script>
</body>
</html>
