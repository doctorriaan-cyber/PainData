<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pain</title>
    <meta name="description" content="An application to import, view, edit, and export patient data from an XLSX file, designed for mobile use." />
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoicGFpbiIsInNob3J0X25hbWUiOiJwYWluIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMxMjMxMzMiLCJ0aGVtZV9jb2xvciI6IiMxMjMxMzMiLCJkZXNjcmlwdGlvbiI6IkFuIGFwcGxpY2F0aW9uIHRvIGltcG9ydCwgdmlldywgZWRpdCwgYW5kIGV4cG9ydCBwYXRpZW50IGRhdGEuIiwiaWNvbnMiOlt7InNyYyI6ImNyb3BwZWQucG5nIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3BuZyIsInB1cnBvc2UiOiJhbnkgbWFza2FibGUifV19" />
    <meta name="theme-color" content="#123133" />
    <link rel="apple-touch-icon" href="cropped.png" />
    
    <!-- CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-[#123133]">
    <div id="root"></div>

    <script type="text/babel">
        // --- From components/icons.tsx ---
        const UploadIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path d="M5.5 13a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.977A4.5 4.5 0 1113.5 13H11V9.414l-1.293 1.293a1 1 0 01-1.414-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 9.414V13H5.5z" />
                <path d="M9 13h2v5H9v-5z" />
            </svg>
        );

        const DownloadIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 9.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 7.414V13a1 1 0 11-2 0V7.414L6.293 9.707z" clipRule="evenodd" />
            </svg>
        );

        const InstallIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" className="w-5 h-5">
              <path d="M10.75 2.75a.75.75 0 0 0-1.5 0v8.614L6.295 8.235a.75.75 0 1 0-1.09 1.03l4.25 4.5a.75.75 0 0 0 1.09 0l4.25-4.5a.75.75 0 0 0-1.09-1.03l-2.955 3.129V2.75Z" />
              <path d="M3.5 12.75a.75.75 0 0 0-1.5 0v2.5A2.75 2.75 0 0 0 4.75 18h10.5A2.75 2.75 0 0 0 18 15.25v-2.5a.75.75 0 0 0-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5Z" />
            </svg>
        );

        const ChevronDownIcon = ({ isOpen }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={`h-6 w-6 transform transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
            </svg>
        );

        const CloseIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
        );

        const TrashIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" />
            </svg>
        );

        const WarningIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-12 w-12 text-yellow-400 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
        );
        
        const Logo = () => (
            <svg className="h-24 mx-auto mb-2" viewBox="52 15 100 120" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M0,0 L2,0 L2,7 L3,7 L3,12 L4,12 L4,15 L5,15 L5,17 L6,17 L6,19 L7,19 L7,21 L8,21 L8,23 L9,23 L9,25 L10,25 L10,26 L11,26 L11,27 L12,27 L12,29 L13,29 L13,30 L14,30 L14,31 L15,31 L15,32 L16,32 L16,33 L17,33 L17,34 L18,34 L18,36 L19,36 L19,37 L21,37 L21,38 L22,38 L22,39 L23,39 L23,40 L24,40 L24,41 L25,41 L25,42 L26,42 L26,43 L27,43 L27,44 L28,44 L28,45 L29,45 L29,46 L30,46 L30,47 L31,47 L31,48 L32,48 L32,49 L33,49 L33,50 L34,50 L34,51 L36,51 L36,52 L37,52 L37,53 L38,53 L38,54 L39,54 L39,55 L40,55 L40,56 L41,56 L41,57 L43,57 L43,58 L45,58 L45,59 L46,59 L46,60 L47,60 L47,61 L48,61 L48,62 L49,62 L49,63 L50,63 L50,64 L51,64 L51,66 L52,66 L52,67 L53,67 L53,68 L54,68 L54,70 L55,70 L55,71 L56,71 L56,73 L57,73 L57,75 L58,75 L58,77 L59,77 L59,80 L60,80 L60,84 L61,84 L61,96 L60,96 L60,97 L59,97 L59,98 L55,98 L55,99 L53,99 L53,100 L52,100 L52,101 L47,101 L47,100 L23,100 L23,101 L19,101 L19,100 L18,100 L18,99 L14,99 L14,98 L11,98 L11,97 L10,97 L10,93 L9,93 L9,91 L10,91 L10,81 L11,81 L11,80 L12,80 L12,77 L13,77 L13,74 L14,74 L14,73 L15,73 L15,71 L16,71 L16,67 L17,67 L17,66 L18,66 L18,64 L19,64 L19,61 L20,61 L20,60 L21,60 L21,59 L23,59 L23,60 L24,60 L24,61 L25,61 L25,62 L27,62 L27,63 L29,63 L29,64 L30,64 L30,65 L29,65 L29,67 L28,67 L28,69 L38,69 L38,67 L37,67 L37,66 L36,66 L36,65 L35,65 L35,64 L34,64 L34,63 L33,63 L33,62 L32,62 L32,61 L30,61 L30,60 L28,60 L28,59 L27,59 L27,58 L26,58 L26,57 L25,57 L25,56 L23,56 L23,55 L22,55 L22,54 L21,54 L21,53 L20,53 L20,52 L19,52 L19,51 L18,51 L18,50 L17,50 L17,49 L16,49 L16,48 L15,48 L15,47 L14,47 L14,46 L13,46 L13,45 L12,45 L12,43 L11,43 L11,42 L10,42 L10,41 L9,41 L9,40 L8,40 L8,39 L7,39 L7,38 L6,38 L6,37 L5,37 L5,36 L4,36 L4,35 L3,35 L3,34 L2,34 L2,91 L0,91 L0,90 L-1,90 L-1,89 L-2,89 L-2,88 L-3,88 L-3,87 L-4,87 L-4,86 L-5,86 L-5,85 L-6,85 L-6,84 L-7,84 L-7,83 L-8,83 L-8,8 L-7,8 L-7,6 L-6,6 L-6,5 L-5,5 L-5,4 L-4,4 L-4,3 L-3,3 L-3,2 L-1,2 L-1,1 L0,1 Z " fill="#C2CFCA" transform="translate(67,30)"/>
                <path d="M0,0 L3,0 L3,2 L4,2 L4,4 L5,4 L5,5 L6,5 L6,3 L5,3 L5,1 L4,1 L4,0 L6,0 L6,1 L7,1 L7,3 L8,3 L8,6 L9,6 L9,8 L11,8 L11,9 L15,9 L15,8 L18,8 L18,3 L19,3 L19,2 L20,2 L20,0 L22,0 L22,2 L21,2 L21,4 L22,4 L22,3 L23,3 L23,1 L24,1 L24,0 L26,0 L26,1 L29,1 L29,2 L32,2 L32,3 L35,3 L35,4 L37,4 L37,5 L38,5 L38,6 L39,6 L39,19 L38,19 L38,21 L37,21 L37,25 L36,25 L36,28 L35,28 L35,29 L34,29 L34,33 L33,33 L33,35 L32,35 L32,38 L31,38 L31,40 L30,40 L30,41 L29,41 L29,43 L28,43 L28,44 L27,44 L27,45 L26,45 L26,44 L24,44 L24,43 L23,43 L23,42 L22,42 L22,41 L21,41 L21,40 L20,40 L20,39 L19,39 L19,37 L20,37 L20,36 L21,36 L21,33 L23,33 L23,30 L24,30 L24,28 L25,28 L25,26 L26,26 L26,24 L27,24 L27,19 L23,19 L23,20 L22,20 L22,21 L21,21 L21,23 L20,23 L20,28 L19,28 L19,27 L18,27 L18,26 L17,26 L17,25 L16,25 L16,24 L11,24 L11,25 L9,25 L9,24 L8,24 L8,22 L7,22 L7,20 L5,20 L5,19 L4,19 L4,18 L5,18 L5,16 L6,16 L6,15 L7,15 L7,13 L8,13 L8,12 L6,12 L6,11 L7,11 L7,9 L6,9 L6,8 L5,8 L5,7 L4,7 L4,6 L3,6 L3,4 L2,4 L2,3 L1,3 L1,4 L0,4 L0,6 L-1,6 L-1,10 L-2,10 L-2,18 L1,18 L1,19 L-1,19 L-1,21 L0,21 L0,23 L1,23 L1,25 L2,25 L2,28 L3,28 L3,29 L5,29 L5,31 L6,31 L6,32 L7,32 L7,34 L8,34 L8,35 L9,35 L9,36 L10,36 L10,37 L11,37 L11,38 L12,38 L12,39 L14,39 L14,40 L16,40 L16,41 L17,41 L17,42 L18,42 L18,43 L19,43 L19,44 L20,44 L20,45 L21,45 L21,46 L23,46 L23,47 L24,47 L24,48 L25,48 L25,49 L26,49 L26,50 L28,50 L28,51 L29,51 L29,52 L30,52 L30,53 L31,53 L31,54 L32,54 L32,55 L33,55 L33,56 L34,56 L34,57 L35,57 L35,58 L36,58 L36,59 L37,59 L37,60 L38,60 L38,61 L39,61 L39,62 L40,62 L40,63 L41,63 L41,65 L42,65 L42,66 L43,66 L43,67 L44,67 L44,68 L46,68 L46,66 L45,66 L45,65 L46,65 L46,63 L45,63 L45,62 L46,62 L46,12 L45,12 L45,11 L46,11 L46,10 L47,10 L47,11 L49,11 L49,12 L50,12 L50,13 L51,13 L51,14 L52,14 L52,15 L53,15 L53,16 L54,16 L54,17 L55,17 L55,18 L56,18 L56,19 L57,19 L57,93 L56,93 L56,95 L55,95 L55,96 L54,96 L54,97 L53,97 L53,98 L52,98 L52,99 L50,99 L50,100 L49,100 L49,101 L48,101 L48,102 L46,102 L46,97 L45,97 L45,92 L44,92 L44,89 L43,89 L43,85 L42,85 L42,83 L41,83 L41,81 L40,81 L40,79 L39,79 L39,78 L38,78 L38,76 L37,76 L37,75 L36,75 L36,74 L35,74 L35,72 L34,72 L34,71 L33,71 L33,70 L32,70 L32,69 L31,69 L31,68 L30,68 L30,67 L29,67 L29,66 L28,66 L28,65 L27,65 L27,64 L26,64 L26,63 L25,63 L25,62 L24,62 L24,61 L23,61 L23,60 L21,60 L21,59 L20,59 L20,58 L19,58 L19,57 L18,57 L18,56 L17,56 L17,55 L16,55 L16,54 L14,54 L14,53 L12,53 L12,52 L11,52 L11,51 L10,51 L10,50 L9,50 L9,49 L8,49 L8,48 L7,48 L7,47 L6,47 L6,46 L4,46 L4,45 L3,45 L3,44 L2,44 L2,43 L1,43 L1,42 L0,42 L0,41 L-1,41 L-1,40 L-2,40 L-2,38 L-3,38 L-3,37 L-4,37 L-4,36 L-5,36 L-5,35 L-6,35 L-6,34 L-7,34 L-7,32 L-8,32 L-8,29 L-9,29 L-9,27 L-10,27 L-10,24 L-11,24 L-11,21 L-12,21 L-12,7 L-11,7 L-11,5 L-10,5 L-10,4 L-9,4 L-9,3 L-5,3 L-5,2 L-4,2 L-4,1 L0,1 Z M20,4 L20,5 L21,5 L21,4 Z M3,16 L4,16 L4,18 L1,18 L1,17 L3,17 Z M8,25 L9,25 L9,27 L8,27 L8,28 L6,28 L6,27 L7,27 L7,26 L8,26 Z M5,28 L6,28 L6,29 L5,29 Z " fill="#C6D2CD" transform="translate(89,19)"/>
            </svg>
        );

        // --- From services/xlsxService.ts ---
        const getCellValue = (worksheet, address) => {
          const cell = worksheet[address];
          if (!cell) return '';

          if (cell.t === 'd' && cell.v instanceof Date) {
            const date = cell.v;
            if (!isNaN(date.getTime())) {
              const hours = String(date.getHours()).padStart(2, '0');
              const minutes = String(date.getMinutes()).padStart(2, '0');
              return `${hours}:${minutes}`;
            }
          }

          if (cell.w) {
            return cell.w;
          }
          
          return cell.v !== null && cell.v !== undefined ? String(cell.v) : '';
        };

        const parsePatientData = async (file) => {
          const data = await file.arrayBuffer();
          const workbook = XLSX.read(data, { cellDates: true });
          const worksheet = workbook.Sheets[workbook.SheetNames[0]];

          const p2RawValue = getCellValue(worksheet, 'P2') || '';
          const p2Part = p2RawValue.split(',')[0].trim();

          const p4RawValue = getCellValue(worksheet, 'P4') || '';
          const p4Part = p4RawValue.split(' ')[0].trim();
          
          const sectionHeader = [p2Part, p4Part].filter(Boolean).join(', ');
          
          const patients = [];
          let patientIndex = 0;
          
          while (true) {
            const startRow = patientIndex * 12 + 1;
            const nameCellAddress = `M${startRow}`;
            const patientName = getCellValue(worksheet, nameCellAddress);

            if (!patientName) {
              break;
            }

            const notes = [];
            for (let i = 0; i < 7; i++) {
                notes.push(getCellValue(worksheet, `M${startRow + 1 + i}`));
            }
            
            const patient = {
              id: `${file.name}-${patientIndex}`,
              name: patientName,
              age: getCellValue(worksheet, `N${startRow}`),
              procedure: getCellValue(worksheet, `M${startRow + 8}`),
              inTime: getCellValue(worksheet, `K${startRow + 3}`),
              outTime: getCellValue(worksheet, `K${startRow + 4}`),
              weight: getCellValue(worksheet, `K${startRow + 5}`),
              height: getCellValue(worksheet, `K${startRow + 6}`),
              sedationType: getCellValue(worksheet, `K${startRow + 7}`),
              tci: getCellValue(worksheet, `K${startRow + 8}`),
              notes: notes,
              ketamineAmount: getCellValue(worksheet, `N${startRow + 10}`),
              originalRow: startRow,
            };
            
            patients.push(patient);
            patientIndex++;
          }
          
          return { sectionHeader, patients };
        };

        const exportPatientData = (patients, fileName = 'pain_data_export.xlsx') => {
            const wb = XLSX.utils.book_new();
            const ws = {};

            patients.forEach(patient => {
                const r = patient.originalRow;
                
                const addCell = (address, value) => {
                    if (value === null || value === undefined || value === '') return;
                    const cell = { t: 's', v: String(value) };
                    ws[address] = cell;
                };

                addCell(`M${r}`, patient.name);
                addCell(`N${r}`, patient.age);
                addCell(`K${r + 3}`, patient.inTime);
                addCell(`K${r + 4}`, patient.outTime);
                addCell(`K${r + 5}`, patient.weight);
                addCell(`K${r + 6}`, patient.height);
                addCell(`K${r + 7}`, patient.sedationType);
                addCell(`K${r + 8}`, patient.tci);
                addCell(`M${r + 8}`, patient.procedure);
                addCell(`N${r + 10}`, patient.ketamineAmount);

                patient.notes.forEach((note, index) => {
                    addCell(`M${r + 1 + index}`, note);
                });
            });

            if (Object.keys(ws).length > 0) {
                const range = { s: { c: 10000, r: 10000 }, e: { c: 0, r: 0 } };
                Object.keys(ws).forEach(address => {
                    if (address === '!ref') return;
                    const cellRef = XLSX.utils.decode_cell(address);
                    range.s.c = Math.min(range.s.c, cellRef.c);
                    range.s.r = Math.min(range.s.r, cellRef.r);
                    range.e.c = Math.max(range.e.c, cellRef.c);
                    range.e.r = Math.max(range.e.r, cellRef.r);
                });
                ws['!ref'] = XLSX.utils.encode_range(range);
            } else {
                ws['!ref'] = 'A1';
            }
            
            XLSX.utils.book_append_sheet(wb, ws, "Patient Data");
            XLSX.writeFile(wb, fileName);
        };

        // --- From components/ConfirmModal.tsx ---
        const ConfirmModal = ({ title, message, onConfirm, onClose }) => {
            return (
                <div 
                    className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50"
                    aria-modal="true"
                    role="dialog"
                    onClick={onClose}
                >
                    <div 
                        className="bg-[#184144] rounded-lg shadow-2xl w-full max-w-sm border border-[#255356] text-center"
                        onClick={(e) => e.stopPropagation()}
                    >
                        <div className="p-6">
                            <WarningIcon />
                            <h2 className="text-xl font-bold text-[#F56565] mb-2">{title}</h2>
                            <p className="text-[#B8C0C1]">{message}</p>
                        </div>
                        <div className="p-4 bg-[#123133]/50 flex justify-center space-x-4 rounded-b-lg">
                             <button
                                onClick={onClose}
                                className="px-6 py-2 bg-[#4a6566] hover:bg-[#3e5556] text-white font-semibold rounded-lg w-full"
                            >
                                Cancel
                            </button>
                            <button
                                onClick={onConfirm}
                                className="px-6 py-2 bg-[#E53E3E] hover:bg-[#C53030] text-white font-semibold rounded-lg w-full"
                            >
                                Confirm
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- From components/ExportModal.tsx ---
        const ExportModal = ({ sections, onSelect, onClose }) => {
            return (
                <div 
                    className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50"
                    aria-modal="true"
                    role="dialog"
                    onClick={onClose}
                >
                    <div 
                        className="bg-[#184144] rounded-lg shadow-2xl w-full max-w-sm border border-[#255356]"
                        onClick={(e) => e.stopPropagation()}
                    >
                        <div className="flex justify-between items-center p-4 border-b border-[#35686b]">
                            <h2 className="text-xl font-bold text-[#EAEFF0]">Select Section to Export</h2>
                            <button onClick={onClose} className="text-[#B8C0C1] hover:text-[#EAEFF0]">
                                <CloseIcon />
                            </button>
                        </div>
                        <div className="p-4 max-h-80 overflow-y-auto">
                            <p className="text-[#B8C0C1] mb-4">Choose which imported file you would like to export.</p>
                            <div className="space-y-3">
                                {sections.map((section, index) => (
                                    <button
                                        key={`${section.sectionHeader}-${index}`}
                                        onClick={() => onSelect(section)}
                                        className="w-full text-left px-4 py-3 bg-[#255356] hover:bg-[#246364] text-[#EAEFF0] rounded-md transition-colors duration-200"
                                    >
                                        {section.sectionHeader}
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div className="p-4 border-t border-[#35686b] text-right">
                             <button
                                onClick={onClose}
                                className="px-4 py-2 bg-[#4a6566] hover:bg-[#3e5556] text-white font-semibold rounded-lg"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- From components/PatientAccordion.tsx ---
        const InputField = ({ label, name, value, onChange }) => (
            <div>
                <label htmlFor={name} className="block text-sm font-medium text-[#B8C0C1] mb-1">{label}</label>
                <input
                    type="text"
                    id={name}
                    name={name}
                    value={value}
                    onChange={onChange}
                    className="w-full bg-[#255356] border border-[#35686b] rounded-md px-3 py-2 text-[#EAEFF0] focus:ring-2 focus:ring-[#246364] focus:border-[#246364]"
                />
            </div>
        );

        const PatientAccordion = ({ patient, onUpdate }) => {
            const [isOpen, setIsOpen] = React.useState(false);
            const accordionRef = React.useRef(null);

            React.useEffect(() => {
                if (isOpen) {
                    const timer = setTimeout(() => {
                        accordionRef.current?.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start',
                        });
                    }, 150);
                    return () => clearTimeout(timer);
                }
            }, [isOpen]);

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                onUpdate({ ...patient, [name]: value });
            };

            const handleNoteChange = (index, value) => {
                const newNotes = [...patient.notes];
                newNotes[index] = value;
                onUpdate({ ...patient, notes: newNotes });
            };

            const isComplete = React.useMemo(() => {
                return !!(
                    patient.inTime &&
                    patient.outTime &&
                    patient.weight &&
                    patient.height &&
                    patient.tci
                );
            }, [patient.inTime, patient.outTime, patient.weight, patient.height, patient.tci]);

            const { name, age, bmi } = React.useMemo(() => {
                const weightNum = parseFloat(patient.weight);
                const heightNum = parseFloat(patient.height);
                let calculatedBmi = null;

                if (weightNum > 0 && heightNum > 0) {
                    const heightInMeters = heightNum; // Height is expected in meters
                    calculatedBmi = (weightNum / (heightInMeters * heightInMeters)).toFixed(1);
                }

                return {
                    name: patient.name || 'Unnamed Patient',
                    age: patient.age ? `Age: ${patient.age}` : '',
                    bmi: (calculatedBmi && !isNaN(calculatedBmi)) ? `BMI: ${calculatedBmi}` : '',
                };
            }, [patient.name, patient.age, patient.weight, patient.height]);

            return (
                <div className="bg-[#184144] rounded-lg shadow-lg overflow-hidden" ref={accordionRef}>
                    <button
                        onClick={() => setIsOpen(!isOpen)}
                        className="w-full flex justify-between items-center p-4 text-left hover:bg-[#255356] focus:outline-none focus:bg-[#255356]"
                        aria-expanded={isOpen}
                    >
                        <div className="flex items-center min-w-0">
                             <span
                                className={`w-3 h-3 rounded-full mr-3 flex-shrink-0 self-start mt-2 ${isComplete ? 'bg-[#48BB78]' : 'bg-[#F56565]'}`}
                                title={isComplete ? 'All fields complete' : 'Missing required data'}
                            ></span>
                            <div className="flex flex-col min-w-0">
                                <span className="truncate font-semibold text-lg text-[#EAEFF0]" title={name}>{name}</span>
                                {(age || bmi) && (
                                    <span className="text-sm text-[#B8C0C1]">
                                        {age}{age && bmi ? ', ' : ''}{bmi}
                                    </span>
                                )}
                                {patient.procedure && (
                                    <span className="text-sm text-[#B8C0C1] mt-1 truncate" title={patient.procedure}>
                                        {patient.procedure}
                                    </span>
                                )}
                            </div>
                        </div>
                        <ChevronDownIcon isOpen={isOpen} />
                    </button>
                    <div className={`grid transition-all duration-500 ease-in-out ${isOpen ? 'grid-rows-[1fr]' : 'grid-rows-[0fr]'}`}>
                        <div className="overflow-hidden">
                            <div className="p-4 border-t border-[#255356] space-y-4">
                                <div className="grid grid-cols-2 gap-4">
                                    <InputField label="Weight (kg)" name="weight" value={patient.weight} onChange={handleInputChange} />
                                    <InputField label="Height (m)" name="height" value={patient.height} onChange={handleInputChange} />
                                    <InputField label="In Time" name="inTime" value={patient.inTime} onChange={handleInputChange} />
                                    <InputField label="Out Time" name="outTime" value={patient.outTime} onChange={handleInputChange} />
                                    <InputField label="TCI" name="tci" value={patient.tci} onChange={handleInputChange} />
                                    <InputField label="Ketamine Amount" name="ketamineAmount" value={patient.ketamineAmount} onChange={handleInputChange} />
                                    <div className="col-span-2">
                                        <div>
                                            <label htmlFor="sedationType" className="block text-sm font-medium text-[#B8C0C1] mb-1">Sedation Type</label>
                                            <select
                                                id="sedationType"
                                                name="sedationType"
                                                value={patient.sedationType}
                                                onChange={handleInputChange}
                                                className="w-full bg-[#255356] border border-[#35686b] rounded-md px-3 py-2 text-[#EAEFF0] focus:ring-2 focus:ring-[#246364] focus:border-[#246364]"
                                            >
                                                <option value="Deep">Deep</option>
                                                <option value="Awake">Awake</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-[#B8C0C1] mb-1">Patient Notes</label>
                                    <div className="space-y-2">
                                        {patient.notes.map((note, index) => (
                                            <textarea
                                                key={index}
                                                value={note}
                                                onChange={(e) => handleNoteChange(index, e.target.value)}
                                                placeholder={`Note ${index + 1}`}
                                                rows={1}
                                                className="w-full bg-[#255356] border border-[#35686b] rounded-md px-3 py-2 text-[#EAEFF0] focus:ring-2 focus:ring-[#246364] focus:border-[#246364] resize-y"
                                            />
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- From App.tsx ---
        const App = () => {
            const { useState, useRef, useCallback, useEffect } = React;
            const LOCAL_STORAGE_KEY = 'patientDataManagerData';

            const [allPatientData, setAllPatientData] = useState(() => {
                try {
                    const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                    return savedData ? JSON.parse(savedData) : [];
                } catch (error) {
                    console.error("Failed to load data from local storage", error);
                    return [];
                }
            });

            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);
            const [isExportModalOpen, setIsExportModalOpen] = useState(false);
            const [isConfirmModalOpen, setIsConfirmModalOpen] = useState(false);
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const fileInputRef = useRef(null);

            useEffect(() => {
                // Service Worker Registration
                if ('serviceWorker' in navigator) {
                    const swCode = `
                        const CACHE_NAME = 'pain-data-manager-cache-v1';
                        const urlsToCache = ['./', './index.html', './cropped.png'];

                        self.addEventListener('install', (event) => {
                            event.waitUntil(
                                caches.open(CACHE_NAME).then((cache) => {
                                    return cache.addAll(urlsToCache);
                                })
                            );
                        });

                        self.addEventListener('fetch', (event) => {
                            event.respondWith(
                                caches.match(event.request).then((response) => {
                                    return response || fetch(event.request);
                                })
                            );
                        });
                    `;
                    const blob = new Blob([swCode], { type: 'application/javascript' });
                    const swUrl = URL.createObjectURL(blob);

                    navigator.serviceWorker.register(swUrl)
                        .then((reg) => console.log('Service Worker registered.'))
                        .catch((err) => console.log('Service Worker registration failed:', err));
                }
                
                // Install prompt logic
                const handleBeforeInstallPrompt = (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                };

                window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);

                return () => {
                    window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
                };
            }, []);
            
            useEffect(() => {
                try {
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allPatientData));
                } catch (error) {
                    console.error("Failed to save data to local storage", error);
                    setError("Could not save data. Your browser's storage might be full.");
                }
            }, [allPatientData]);
            
            const handleInstallClick = async () => {
                if (!deferredPrompt) {
                    return;
                }
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                }
                setDeferredPrompt(null);
            };

            const handleFileImport = async (event) => {
                const file = event.target.files?.[0];
                if (!file) return;

                setIsLoading(true);
                setError(null);
                try {
                    const data = await parsePatientData(file);
                    if (data.patients.length === 0) {
                      setError("No patient data found in the file. Please check the format.");
                    } else {
                      setAllPatientData(prevData => [...prevData, data]);
                    }
                } catch (err) {
                    console.error(err);
                    setError('Failed to parse the file. Please ensure it is a valid XLSX file with the correct format.');
                } finally {
                    setIsLoading(false);
                    if (fileInputRef.current) {
                        fileInputRef.current.value = '';
                    }
                }
            };

            const performExport = (section) => {
                const headerPart = section.sectionHeader.split(',')[0].trim();
                const fileName = `${headerPart || 'pain_data'}.xlsx`;
                try {
                    exportPatientData(section.patients, fileName);
                } catch (err) {
                    console.error(err);
                    setError('Failed to export data.');
                }
            };

            const handleExport = () => {
                if (!allPatientData || allPatientData.length === 0) {
                    alert('No patient data to export.');
                    return;
                }
                
                if (allPatientData.length === 1) {
                    performExport(allPatientData[0]);
                } else {
                    setIsExportModalOpen(true);
                }
            };
            
            const handleSelectAndExport = (section) => {
                performExport(section);
                setIsExportModalOpen(false);
            };

            const handlePatientUpdate = useCallback((updatedPatient) => {
                setAllPatientData(currentAllData =>
                    currentAllData.map(section => ({
                        ...section,
                        patients: section.patients.map(p =>
                            p.id === updatedPatient.id ? updatedPatient : p
                        ),
                    }))
                );
            }, []);

            const handleClearAll = () => {
                setIsConfirmModalOpen(true);
            };

            const performClearAll = () => {
                setAllPatientData([]);
                setIsConfirmModalOpen(false);
            };
            
            const triggerFileInput = () => {
                fileInputRef.current?.click();
            };

            return (
                <div className="min-h-screen bg-[#123133] text-[#EAEFF0] font-sans">
                    <div className="max-w-md mx-auto p-4">
                        <header className="py-4">
                            <Logo />
                            <h1 className="text-5xl font-bold text-center text-white mb-4 tracking-wider">pain</h1>
                        </header>

                        <main className="mt-6 space-y-6">
                            {isLoading && <p className="text-center text-lg text-[#66d1cc]">Processing file...</p>}
                            {error && <p className="text-center text-lg text-[#F56565] bg-red-500/20 p-3 rounded-lg">{error}</p>}
                            
                            {!isLoading && allPatientData.length === 0 && !error && (
                                <div className="text-center text-[#B8C0C1] mt-16 p-6 bg-[#184144] rounded-lg">
                                    <p className="text-xl">Welcome!</p>
                                    <p>Click "Import" to load patient data.</p>
                                </div>
                            )}

                            {allPatientData.map((patientData, index) => (
                                patientData.patients.length > 0 && (
                                    <div key={`${patientData.sectionHeader}-${index}`} className="bg-black/20 rounded-lg shadow-lg overflow-hidden border border-[#255356]">
                                         <h2 className="p-4 text-xl font-bold text-center text-white bg-[#184144]">
                                            {patientData.sectionHeader}
                                         </h2>
                                        <div className="p-4 space-y-3">
                                            {patientData.patients.map((patient) => (
                                                <PatientAccordion
                                                    key={patient.id}
                                                    patient={patient}
                                                    onUpdate={handlePatientUpdate}
                                                />
                                            ))}
                                        </div>
                                    </div>
                                )
                            ))}
                        </main>
                        
                        <footer className="mt-8 pt-6 border-t border-[#255356]">
                            <div className="flex justify-center space-x-2 flex-wrap gap-2">
                                <button
                                    onClick={triggerFileInput}
                                    className="flex items-center justify-center px-4 py-3 bg-[#246364] hover:bg-[#1e5051] text-white font-semibold rounded-lg shadow-md transition-transform transform hover:scale-105"
                                    aria-label="Import XLSX file"
                                >
                                    <UploadIcon />
                                    <span className="ml-2 hidden sm:inline">Import</span>
                                </button>
                                <input
                                    type="file"
                                    ref={fileInputRef}
                                    onChange={handleFileImport}
                                    className="hidden"
                                    accept=".xlsx"
                                />
                                <button
                                    onClick={handleExport}
                                    disabled={allPatientData.length === 0}
                                    className="flex items-center justify-center px-4 py-3 bg-[#2F855A] hover:bg-[#276c4a] text-white font-semibold rounded-lg shadow-md transition-transform transform hover:scale-105 disabled:bg-[#4a6566] disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                                    aria-label="Export data to XLSX file"
                                >
                                    <DownloadIcon />
                                    <span className="ml-2 hidden sm:inline">Export</span>
                                </button>
                                <button
                                    onClick={handleClearAll}
                                    disabled={allPatientData.length === 0}
                                    className="flex items-center justify-center px-4 py-3 bg-[#E53E3E] hover:bg-[#C53030] text-white font-semibold rounded-lg shadow-md transition-transform transform hover:scale-105 disabled:bg-[#4a6566] disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                                    aria-label="Clear all data"
                                >
                                    <TrashIcon />
                                    <span className="ml-2 hidden sm:inline">Clear All</span>
                                </button>
                                {deferredPrompt && (
                                    <button
                                        onClick={handleInstallClick}
                                        className="flex items-center justify-center px-4 py-3 bg-[#6B46C1] hover:bg-[#553C9A] text-white font-semibold rounded-lg shadow-md transition-transform transform hover:scale-105"
                                        aria-label="Install application"
                                    >
                                        <InstallIcon />
                                        <span className="ml-2 hidden sm:inline">Install App</span>
                                    </button>
                                )}
                            </div>
                        </footer>
                    </div>
                    
                    {isExportModalOpen && (
                        <ExportModal
                            sections={allPatientData}
                            onSelect={handleSelectAndExport}
                            onClose={() => setIsExportModalOpen(false)}
                        />
                    )}
                    {isConfirmModalOpen && (
                        <ConfirmModal
                            title="Confirm Clear All"
                            message="Are you sure you want to delete all patient data? This action cannot be undone."
                            onConfirm={performClearAll}
                            onClose={() => setIsConfirmModalOpen(false)}
                        />
                    )}
                </div>
            );
        };

        // --- From index.tsx ---
        const rootElement = document.getElementById('root');
        if (!rootElement) {
          throw new Error("Could not find root element to mount to");
        }

        const root = ReactDOM.createRoot(rootElement);
        root.render(
          <React.StrictMode>
            <App />
          </React.StrictMode>
        );
    </script>
</body>
</html>
