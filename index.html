<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>pain</title>
    <meta name="description" content="An application to import, view, edit, and export patient data from an XLSX file, designed for mobile use." />
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoicGFpbiIsInNob3J0X25hbWUiOiJwYWluIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwMDM2MzgiLCJ0aGVtZV9jb2xvciI6IiMwMDM2MzgiLCJkZXNjcmlwdGlvbiI6IkFuIGFwcGxpY2F0aW9uIHRvIGltcG9ydCwgdmlldywgZWRpdCwgYW5kIGV4cG9ydCBwYXRpZW50IGRhdGEuIiwiaWNvbnMiOlt7InNyYyI6ImNyb3BwZWQucG5nIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3BuZyIsInB1cnBvc2UiOiJhbnkgbWFza2FibGUifV19" />
    <meta name="theme-color" content="#003638" />
    <link rel="apple-touch-icon" href="cropped.png" />
    
    <!-- CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-[#003638]">
    <div id="root"></div>

    <script type="text/babel">
        // --- From components/icons.tsx ---
        const UploadIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path d="M5.5 13a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.977A4.5 4.5 0 1113.5 13H11V9.414l-1.293 1.293a1 1 0 01-1.414-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 9.414V13H5.5z" />
                <path d="M9 13h2v5H9v-5z" />
            </svg>
        );

        const DownloadIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 9.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 7.414V13a1 1 0 11-2 0V7.414L6.293 9.707z" clipRule="evenodd" />
            </svg>
        );

        const InstallIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" className="w-5 h-5">
              <path d="M10.75 2.75a.75.75 0 0 0-1.5 0v8.614L6.295 8.235a.75.75 0 1 0-1.09 1.03l4.25 4.5a.75.75 0 0 0 1.09 0l4.25-4.5a.75.75 0 0 0-1.09-1.03l-2.955 3.129V2.75Z" />
              <path d="M3.5 12.75a.75.75 0 0 0-1.5 0v2.5A2.75 2.75 0 0 0 4.75 18h10.5A2.75 2.75 0 0 0 18 15.25v-2.5a.75.75 0 0 0-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5Z" />
            </svg>
        );

        const ChevronDownIcon = ({ isOpen }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={`h-6 w-6 transform transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
            </svg>
        );

        const CloseIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
        );

        const TrashIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" />
            </svg>
        );

        const WarningIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-12 w-12 text-yellow-400 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
        );
        
        const CautionIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
            </svg>
        );

        // --- From services/xlsxService.ts ---
        const getCellValue = (worksheet, address) => {
          const cell = worksheet[address];
          if (!cell) return '';

          if (cell.t === 'd' && cell.v instanceof Date) {
            const date = cell.v;
            if (!isNaN(date.getTime())) {
              const hours = String(date.getUTCHours()).padStart(2, '0');
              const minutes = String(date.getUTCMinutes()).padStart(2, '0');
              return `${hours}:${minutes}`;
            }
          }

          if (cell.w) {
            return cell.w;
          }
          
          return cell.v !== null && cell.v !== undefined ? String(cell.v) : '';
        };

        const parsePatientData = async (file) => {
          const data = await file.arrayBuffer();
          const workbook = XLSX.read(data, { cellDates: true });
          const worksheet = workbook.Sheets[workbook.SheetNames[0]];

          const p2RawValue = getCellValue(worksheet, 'P2') || '';
          const p2Part = p2RawValue.split(',')[0].trim();

          const p4RawValue = getCellValue(worksheet, 'P4') || '';
          const p4Part = p4RawValue.split(' ')[0].trim();
          
          const sectionHeader = [p2Part, p4Part].filter(Boolean).join(', ');
          
          const patients = [];
          let patientIndex = 0;
          
          while (true) {
            const startRow = patientIndex * 12 + 1;
            const nameCellAddress = `M${startRow}`;
            const patientName = getCellValue(worksheet, nameCellAddress);

            if (!patientName) {
              break;
            }

            const notes = [];
            for (let i = 0; i < 7; i++) {
                notes.push(getCellValue(worksheet, `M${startRow + 1 + i}`));
            }
            
            const rawKetamineAmount = getCellValue(worksheet, `N${startRow + 10}`);
            
            const patient = {
              id: `p-${file.name.replace(/\W/g, '_')}-${patientIndex}`,
              name: patientName,
              age: getCellValue(worksheet, `N${startRow}`),
              procedure: getCellValue(worksheet, `M${startRow + 8}`),
              inTime: getCellValue(worksheet, `K${startRow + 3}`),
              outTime: getCellValue(worksheet, `K${startRow + 4}`),
              weight: getCellValue(worksheet, `K${startRow + 5}`),
              height: getCellValue(worksheet, `K${startRow + 6}`),
              sedationType: getCellValue(worksheet, `K${startRow + 7}`) || 'Deep',
              tci: getCellValue(worksheet, `K${startRow + 8}`),
              notes: notes,
              ketamineAmount: rawKetamineAmount === '0' ? '' : rawKetamineAmount,
              originalRow: startRow,
              caution: false,
              penicillinAllergy: false,
            };
            
            patients.push(patient);
            patientIndex++;
          }
          
          return { sectionHeader, patients };
        };

        const exportPatientData = (patients, fileName = 'pain_data_export.xlsx') => {
            const wb = XLSX.utils.book_new();
            const ws = {};

            patients.forEach(patient => {
                const r = patient.originalRow;
                
                const addCell = (address, value) => {
                    if (value === null || value === undefined || value === '') return;
                    const cell = { t: 's', v: String(value) };
                    ws[address] = cell;
                };

                addCell(`M${r}`, patient.name);
                addCell(`N${r}`, patient.age);
                addCell(`K${r + 3}`, patient.inTime);
                addCell(`K${r + 4}`, patient.outTime);
                addCell(`K${r + 5}`, patient.weight);
                addCell(`K${r + 6}`, patient.height);
                addCell(`K${r + 7}`, patient.sedationType);
                addCell(`K${r + 8}`, patient.tci);
                addCell(`M${r + 8}`, patient.procedure);
                addCell(`N${r + 10}`, patient.ketamineAmount || '0');

                patient.notes.forEach((note, index) => {
                    addCell(`M${r + 1 + index}`, note);
                });
            });

            if (Object.keys(ws).length > 0) {
                const range = { s: { c: 10000, r: 10000 }, e: { c: 0, r: 0 } };
                Object.keys(ws).forEach(address => {
                    if (address === '!ref') return;
                    const cellRef = XLSX.utils.decode_cell(address);
                    range.s.c = Math.min(range.s.c, cellRef.c);
                    range.s.r = Math.min(range.s.r, cellRef.r);
                    range.e.c = Math.max(range.e.c, cellRef.c);
                    range.e.r = Math.max(range.e.r, cellRef.r);
                });
                ws['!ref'] = XLSX.utils.encode_range(range);
            } else {
                ws['!ref'] = 'A1';
            }
            
            XLSX.utils.book_append_sheet(wb, ws, "Patient Data");
            XLSX.writeFile(wb, fileName);
        };

        // --- From components/ConfirmModal.tsx ---
        const ConfirmModal = ({ title, message, onConfirm, onClose, sections, selections, onSelectionChange }) => {
            const hasSelections = sections && selections && onSelectionChange;
            
            const handleCheckboxChange = (index) => {
                onSelectionChange({
                    ...selections,
                    [index]: !selections[index],
                });
            };

            const numSelected = hasSelections ? Object.values(selections).filter(Boolean).length : 0;
            const isConfirmDisabled = hasSelections && numSelected === 0;

            return (
                <div 
                    className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50"
                    aria-modal="true"
                    role="dialog"
                    onClick={onClose}
                >
                    <div 
                        className="bg-[#184144] rounded-lg shadow-2xl w-full max-w-sm border border-[#255356] text-left"
                        onClick={(e) => e.stopPropagation()}
                    >
                        <div className="p-6">
                            <div className="text-center">
                                <WarningIcon />
                                <h2 className="text-xl font-bold text-[#F56565] mb-2">{title}</h2>
                            </div>
                            {hasSelections ? (
                                <div className="mt-4 space-y-3 max-h-60 overflow-y-auto">
                                    <p className="text-[#B8C0C1] mb-3">Select the sections you want to delete. Patient numbering will be recalculated.</p>
                                    {sections.map((section, index) => (
                                        <label key={`${section.sectionHeader}-${index}`} className="flex items-center p-3 bg-[#255356] rounded-md cursor-pointer hover:bg-[#246364]">
                                            <input 
                                                type="checkbox"
                                                checked={!!selections[index]}
                                                onChange={() => handleCheckboxChange(index)}
                                                className="h-5 w-5 rounded bg-[#003638] border-[#35686b] text-[#246364] focus:ring-[#246364] focus:ring-offset-[#184144]"
                                            />
                                            <span className="ml-3 text-[#EAEFF0] truncate" title={section.sectionHeader}>{section.sectionHeader}</span>
                                        </label>
                                    ))}
                                </div>
                            ) : (
                                <p className="text-[#B8C0C1] text-center">{message}</p>
                            )}
                        </div>
                        <div className="p-4 bg-[#003638]/50 flex justify-center space-x-4 rounded-b-lg">
                             <button
                                onClick={onClose}
                                className="px-6 py-2 bg-[#4a6566] hover:bg-[#3e5556] text-white font-semibold rounded-lg w-full"
                            >
                                Cancel
                            </button>
                            <button
                                onClick={onConfirm}
                                disabled={isConfirmDisabled}
                                className="px-6 py-2 bg-[#E53E3E] hover:bg-[#C53030] text-white font-semibold rounded-lg w-full disabled:bg-red-800 disabled:cursor-not-allowed disabled:opacity-70"
                            >
                                Confirm
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- From components/ExportModal.tsx ---
        const ExportModal = ({ sections, onSelect, onClose }) => {
            return (
                <div 
                    className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50"
                    aria-modal="true"
                    role="dialog"
                    onClick={onClose}
                >
                    <div 
                        className="bg-[#184144] rounded-lg shadow-2xl w-full max-w-sm border border-[#255356]"
                        onClick={(e) => e.stopPropagation()}
                    >
                        <div className="flex justify-between items-center p-4 border-b border-[#35686b]">
                            <h2 className="text-xl font-bold text-[#EAEFF0]">Select Section to Export</h2>
                            <button onClick={onClose} className="text-[#B8C0C1] hover:text-[#EAEFF0]">
                                <CloseIcon />
                            </button>
                        </div>
                        <div className="p-4 max-h-80 overflow-y-auto">
                            <p className="text-[#B8C0C1] mb-4">Choose which imported file you would like to export.</p>
                            <div className="space-y-3">
                                {sections.map((section, index) => (
                                    <button
                                        key={`${section.sectionHeader}-${index}`}
                                        onClick={() => onSelect(section)}
                                        className="w-full text-left px-4 py-3 bg-[#255356] hover:bg-[#246364] text-[#EAEFF0] rounded-md transition-colors duration-200"
                                    >
                                        {section.sectionHeader}
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div className="p-4 border-t border-[#35686b] text-right">
                             <button
                                onClick={onClose}
                                className="px-4 py-2 bg-[#4a6566] hover:bg-[#3e5556] text-white font-semibold rounded-lg"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- From components/CustomSelect.tsx ---
        const CustomSelect = ({ label, options, value, onChange, id }) => {
            const [isOpen, setIsOpen] = React.useState(false);
            const selectRef = React.useRef(null);

            const handleSelect = (option) => {
                onChange(option);
                setIsOpen(false);
            };

            React.useEffect(() => {
                const handleClickOutside = (event) => {
                    if (selectRef.current && !selectRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => {
                    document.removeEventListener("mousedown", handleClickOutside);
                };
            }, []);
            
            const DropdownArrowIcon = ({ isOpen }) => (
                <svg className={`h-5 w-5 text-[#B8C0C1] transform transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fillRule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clipRule="evenodd" />
                </svg>
            );

            return (
                <div className="relative" ref={selectRef}>
                    <label htmlFor={id} className="block text-sm font-medium text-[#B8C0C1] mb-1">{label}</label>
                    <button
                        type="button"
                        id={id}
                        onClick={() => setIsOpen(!isOpen)}
                        className="w-full bg-[#255356] border border-[#35686b] rounded-md px-3 py-2 text-[#EAEFF0] focus:ring-2 focus:ring-[#246364] focus:border-[#246364] flex justify-between items-center text-left"
                        aria-haspopup="listbox"
                        aria-expanded={isOpen}
                    >
                        <span>{value}</span>
                        <DropdownArrowIcon isOpen={isOpen} />
                    </button>
                    {isOpen && (
                        <div 
                            className="absolute z-10 mt-1 w-full bg-[#184144] border border-[#35686b] rounded-md shadow-lg max-h-60 overflow-auto focus:outline-none"
                            role="listbox"
                        >
                            {options.map((option) => (
                                <div
                                    key={option}
                                    onClick={() => handleSelect(option)}
                                    className="cursor-pointer select-none relative py-2 pl-3 pr-9 text-[#EAEFF0] hover:bg-[#246364]"
                                    role="option"
                                    aria-selected={value === option}
                                >
                                    <span className={`block truncate ${value === option ? 'font-semibold' : 'font-normal'}`}>{option}</span>
                                    {value === option ? (
                                        <span className="absolute inset-y-0 right-0 flex items-center pr-4 text-[#66d1cc]">
                                            <svg className="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                                            </svg>
                                        </span>
                                    ) : null}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- From components/PatientAccordion.tsx ---
        const AutosizeTextarea = (props) => {
            const textareaRef = React.useRef(null);
            const { value } = props;

            React.useLayoutEffect(() => {
                const textarea = textareaRef.current;
                if (textarea) {
                    textarea.style.height = 'auto';
                    textarea.style.height = `${textarea.scrollHeight}px`;
                }
            }, [value]);

            return (
                <textarea
                    ref={textareaRef}
                    rows={1}
                    className="w-full bg-transparent px-3 py-2 text-[#EAEFF0] focus:ring-2 focus:ring-inset focus:ring-[#246364] resize-none overflow-hidden focus:outline-none"
                    {...props}
                />
            );
        };
        
        const InputField = ({ label, name, value, onChange, id }) => (
            <div>
                <label htmlFor={id} className="block text-sm font-medium text-[#B8C0C1] mb-1">{label}</label>
                <input
                    type="text"
                    id={id}
                    name={name}
                    value={value}
                    onChange={onChange}
                    className="w-full bg-[#255356] border border-[#35686b] rounded-md px-3 py-2 text-[#EAEFF0] focus:ring-2 focus:ring-[#246364] focus:border-[#246364]"
                />
            </div>
        );

        // Time calculation helpers
        const parseTime = (timeStr) => {
            if (!timeStr || !/^\d{1,2}:\d{2}$/.test(timeStr)) {
                return null;
            }
            const [hours, minutes] = timeStr.split(':').map(Number);
            if (hours >= 24 || minutes >= 60) {
                return null;
            }
            return hours * 60 + minutes;
        };

        const formatTime = (totalMinutes) => {
            if (totalMinutes === null || isNaN(totalMinutes)) return '--:--';
            const hours = Math.floor(totalMinutes / 60) % 24;
            const minutes = totalMinutes % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        };

        const formatDuration = (totalMinutes) => {
            if (totalMinutes === null || isNaN(totalMinutes) || totalMinutes < 0) return 'N/A';
            if (totalMinutes === 0) return '0m';
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            let durationStr = '';
            if (hours > 0) durationStr += `${hours}h `;
            if (minutes > 0) durationStr += `${minutes}m`;
            return durationStr.trim();
        };

        const PatientAccordion = ({ patient, onUpdate, patientNumber }) => {
            const [isOpen, setIsOpen] = React.useState(false);
            const accordionRef = React.useRef(null);

            React.useEffect(() => {
                if (isOpen) {
                    const timer = setTimeout(() => {
                        accordionRef.current?.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start',
                        });
                    }, 500);
                    return () => clearTimeout(timer);
                }
            }, [isOpen]);

            const handleInputChange = (e) => {
                const { name, value, type, checked } = e.target;
                const newValue = type === 'checkbox' ? checked : value;
                onUpdate({ ...patient, [name]: newValue });
            };
            
            const handleSedationChange = (newValue) => {
                onUpdate({ ...patient, sedationType: newValue });
            };

            const handleNoteChange = (index, value) => {
                const newNotes = [...patient.notes];
                newNotes[index] = value;
                onUpdate({ ...patient, notes: newNotes });
            };

            const isComplete = React.useMemo(() => {
                return !!(
                    patient.inTime &&
                    patient.outTime &&
                    patient.weight &&
                    patient.height &&
                    patient.tci
                );
            }, [patient.inTime, patient.outTime, patient.weight, patient.height, patient.tci]);

            const { name, calculatedBmi } = React.useMemo(() => {
                const weightNum = parseFloat(patient.weight);
                const heightNum = parseFloat(patient.height);
                let bmi = null;

                if (weightNum > 0 && heightNum > 0) {
                    const heightInMeters = heightNum;
                    bmi = (weightNum / (heightInMeters * heightInMeters)).toFixed(1);
                }

                return {
                    name: patient.name || 'Unnamed Patient',
                    calculatedBmi: (bmi && !isNaN(bmi)) ? bmi : null,
                };
            }, [patient.name, patient.weight, patient.height]);

            const { totalTime, timePlus30, timePlus45 } = React.useMemo(() => {
                const inTimeMinutes = parseTime(patient.inTime);
                const outTimeMinutes = parseTime(patient.outTime);

                let totalDuration = null;
                if (inTimeMinutes !== null && outTimeMinutes !== null) {
                    let duration = outTimeMinutes - inTimeMinutes;
                    if (duration < 0) { // Handles overnight case
                        duration += 24 * 60;
                    }
                    totalDuration = formatDuration(duration);
                }

                const plus30 = inTimeMinutes !== null ? formatTime(inTimeMinutes + 30) : '--:--';
                const plus45 = inTimeMinutes !== null ? formatTime(inTimeMinutes + 45) : '--:--';

                return {
                    totalTime: totalDuration || 'N/A',
                    timePlus30: plus30,
                    timePlus45: plus45,
                };
            }, [patient.inTime, patient.outTime]);
            
            const headerDetailsItems = [];
            if (patient.age) {
                headerDetailsItems.push(
                    <span key="age">Age: <strong className="font-bold text-white">{patient.age}</strong></span>
                );
            }
            if (patient.weight) {
                headerDetailsItems.push(
                    <span key="weight">W: <strong className="font-bold text-white">{patient.weight}</strong>kg</span>
                );
            }
            if (patient.height) {
                headerDetailsItems.push(
                    <span key="height">H: <strong className="font-bold text-white">{patient.height}</strong>m</span>
                );
            }
            if (calculatedBmi) {
                const isBmiHigh = parseFloat(calculatedBmi) >= 35;
                headerDetailsItems.push(
                    <span key="bmi" className={isBmiHigh ? 'underline' : ''}>
                        BMI: <strong className="font-bold text-white">{calculatedBmi}</strong>
                    </span>
                );
            }

            return (
                <div className="bg-[#184144] rounded-lg shadow-lg overflow-hidden">
                    <button
                        onClick={() => setIsOpen(!isOpen)}
                        className={`w-full flex justify-between items-center p-4 text-left focus:outline-none transition-colors duration-200 ${patient.caution ? 'bg-red-400/40 hover:bg-red-400/50 focus:bg-red-400/40' : 'hover:bg-[#255356] focus:bg-[#255356]'}`}
                        aria-expanded={isOpen}
                        ref={accordionRef}
                    >
                        <div className="flex items-start min-w-0">
                            <div className="flex flex-col items-center mr-3 flex-shrink-0 w-8">
                                <span
                                    className={`w-3 h-3 rounded-full ${isComplete ? 'bg-[#48BB78]' : 'bg-[#F56565]'}`}
                                    title={isComplete ? 'All fields complete' : 'Missing required data'}
                                ></span>
                                {patientNumber && (
                                    <span className="text-xl font-bold text-[#B8C0C1] mt-1">{patientNumber}</span>
                                )}
                                <div className="mt-1 h-7 flex items-center justify-center" title={patient.penicillinAllergy ? "Penicillin Allergy" : ""}>
                                    {patient.penicillinAllergy && <span className="text-xl">ðŸ’Š</span>}
                                </div>
                            </div>
                            <div className="flex flex-col min-w-0">
                                <span className="truncate font-semibold text-lg text-[#EAEFF0]" title={name}>{name}</span>
                                {headerDetailsItems.length > 0 && (
                                    <span className="text-sm text-[#B8C0C1]">
                                        {headerDetailsItems.map((item, index) => (
                                            <React.Fragment key={index}>
                                                {item}
                                                {index < headerDetailsItems.length - 1 && ', '}
                                            </React.Fragment>
                                        ))}
                                    </span>
                                )}
                                {patient.procedure && (
                                    <span className="text-sm text-[#B8C0C1] mt-1 truncate" title={patient.procedure}>
                                        {patient.procedure}
                                    </span>
                                )}
                            </div>
                        </div>
                        <ChevronDownIcon isOpen={isOpen} />
                    </button>
                    <div className={`grid transition-all duration-500 ease-in-out ${isOpen ? 'grid-rows-[1fr]' : 'grid-rows-[0fr]'}`}>
                        <div className="overflow-hidden">
                            <div className="p-4 border-t border-[#255356] space-y-4">
                                <div className="grid grid-cols-2 gap-4">
                                    <InputField id={`weight-${patient.id}`} label="Weight (kg)" name="weight" value={patient.weight} onChange={handleInputChange} />
                                    <InputField id={`height-${patient.id}`} label="Height (m)" name="height" value={patient.height} onChange={handleInputChange} />
                                    <InputField id={`inTime-${patient.id}`} label="In Time" name="inTime" value={patient.inTime} onChange={handleInputChange} />
                                    <InputField id={`outTime-${patient.id}`} label="Out Time" name="outTime" value={patient.outTime} onChange={handleInputChange} />
                                    
                                    <div className="col-span-2 grid grid-cols-2 gap-4 items-end">
                                        <div className="grid grid-cols-2 gap-4">
                                            <InputField id={`tci-${patient.id}`} label="TCI" name="tci" value={patient.tci} onChange={handleInputChange} />
                                            <InputField id={`ketamineAmount-${patient.id}`} label="Ketamine" name="ketamineAmount" value={patient.ketamineAmount} onChange={handleInputChange} />
                                        </div>
                                        <div className="text-sm text-[#B8C0C1] pl-2 pb-1 space-y-1">
                                            <div>Total time: <strong className="font-semibold text-[#EAEFF0]">{totalTime}</strong></div>
                                            <div className="text-xs">
                                                30min: <strong className="font-semibold text-[#EAEFF0]">{timePlus30}</strong> | 45min: <strong className="font-semibold text-[#EAEFF0]">{timePlus45}</strong>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="col-span-2 grid grid-cols-3 items-end gap-4">
                                        <CustomSelect
                                            id={`sedationType-${patient.id}`}
                                            label="Sedation Type"
                                            options={['Deep', 'Awake']}
                                            value={patient.sedationType}
                                            onChange={handleSedationChange}
                                        />
                                        <div className="flex flex-col items-center">
                                            <label htmlFor={`caution-${patient.id}`} className="block text-sm font-medium text-[#B8C0C1] mb-1">Caution</label>
                                            <input
                                                type="checkbox"
                                                id={`caution-${patient.id}`}
                                                name="caution"
                                                checked={!!patient.caution}
                                                onChange={handleInputChange}
                                                className="appearance-none h-8 w-8 bg-[#255356] border border-[#35686b] rounded-md cursor-pointer focus:ring-2 focus:ring-offset-2 focus:ring-offset-[#184144] focus:ring-[#246364] checked:bg-[#246364] checked:bg-[url('data:image/svg+xml,%3Csvg%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22white%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M12.207%204.793a1%201%200%20010%201.414l-5%205a1%201%200%2001-1.414%200l-2-2a1%201%200%20011.414-1.414L6.5%209.086l4.293-4.293a1%201%200%20011.414%200z%22%2F%3E%3C%2Fsvg%3E')] checked:bg-center checked:bg-no-repeat"
                                            />
                                        </div>
                                        <div className="flex flex-col items-center">
                                            <label htmlFor={`penicillinAllergy-${patient.id}`} className="block text-sm font-medium text-[#B8C0C1] mb-1">Penicillin Allergy</label>
                                            <input
                                                type="checkbox"
                                                id={`penicillinAllergy-${patient.id}`}
                                                name="penicillinAllergy"
                                                checked={!!patient.penicillinAllergy}
                                                onChange={handleInputChange}
                                                className="appearance-none h-8 w-8 bg-[#255356] border border-[#35686b] rounded-md cursor-pointer focus:ring-2 focus:ring-offset-2 focus:ring-offset-[#184144] focus:ring-[#246364] checked:bg-[#246364] checked:bg-[url('data:image/svg+xml,%3Csvg%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22white%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M12.207%204.793a1%201%200%20010%201.414l-5%205a1%201%200%2001-1.414%200l-2-2a1%201%200%20011.414-1.414L6.5%209.086l4.293-4.293a1%201%200%20011.414%200z%22%2F%3E%3C%2Fsvg%3E')] checked:bg-center checked:bg-no-repeat"
                                            />
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-[#B8C0C1] mb-1">Patient Notes</label>
                                    <div className="bg-[#255356] border border-[#35686b] rounded-md overflow-hidden">
                                        {patient.notes.map((note, index) => (
                                            <div key={index} className={index > 0 ? 'border-t border-[#35686b]' : ''}>
                                                <AutosizeTextarea
                                                    value={note}
                                                    onChange={(e) => handleNoteChange(index, e.target.value)}
                                                    placeholder={`Note ${index + 1}`}
                                                />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- From App.tsx ---
        const App = () => {
            const { useState, useRef, useCallback, useEffect } = React;
            const LOCAL_STORAGE_KEY = 'patientDataManagerData';

            const [allPatientData, setAllPatientData] = useState(() => {
                try {
                    const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                    return savedData ? JSON.parse(savedData) : [];
                } catch (error) {
                    console.error("Failed to load data from local storage", error);
                    return [];
                }
            });

            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);
            const [isExportModalOpen, setIsExportModalOpen] = useState(false);
            const [isConfirmModalOpen, setIsConfirmModalOpen] = useState(false);
            const [selectionsToDelete, setSelectionsToDelete] = useState({});
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const fileInputRef = useRef(null);

            useEffect(() => {
                // Service Worker Registration
                if ('serviceWorker' in navigator) {
                    const swCode = `
                        const CACHE_NAME = 'pain-data-manager-cache-v1';
                        const urlsToCache = ['./', './index.html', './cropped.png'];

                        self.addEventListener('install', (event) => {
                            event.waitUntil(
                                caches.open(CACHE_NAME).then((cache) => {
                                    return cache.addAll(urlsToCache);
                                })
                            );
                        });

                        self.addEventListener('fetch', (event) => {
                            event.respondWith(
                                caches.match(event.request).then((response) => {
                                    return response || fetch(event.request);
                                })
                            );
                        });
                    `;
                    const blob = new Blob([swCode], { type: 'application/javascript' });
                    const swUrl = URL.createObjectURL(blob);

                    navigator.serviceWorker.register(swUrl)
                        .then((reg) => console.log('Service Worker registered.'))
                        .catch((err) => console.log('Service Worker registration failed:', err));
                }
                
                // Install prompt logic
                const handleBeforeInstallPrompt = (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                };

                window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);

                return () => {
                    window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
                };
            }, []);
            
            useEffect(() => {
                try {
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allPatientData));
                } catch (error) {
                    console.error("Failed to save data to local storage", error);
                    setError("Could not save data. Your browser's storage might be full.");
                }
            }, [allPatientData]);
            
            const handleInstallClick = async () => {
                if (!deferredPrompt) {
                    return;
                }
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                }
                setDeferredPrompt(null);
            };

            const handleFileImport = async (event) => {
                const file = event.target.files?.[0];
                if (!file) return;

                setIsLoading(true);
                setError(null);
                try {
                    const data = await parsePatientData(file);
                    if (data.patients.length === 0) {
                      setError("No patient data found in the file. Please check the format.");
                    } else {
                      setAllPatientData(prevData => [...prevData, data]);
                    }
                } catch (err) {
                    console.error(err);
                    setError('Failed to parse the file. Please ensure it is a valid XLSX file with the correct format.');
                } finally {
                    setIsLoading(false);
                    if (fileInputRef.current) {
                        fileInputRef.current.value = '';
                    }
                }
            };

            const performExport = (section) => {
                const headerPart = section.sectionHeader.split(',')[0].trim();
                const fileName = `${headerPart || 'pain_data'}.xlsx`;
                try {
                    exportPatientData(section.patients, fileName);
                } catch (err) {
                    console.error(err);
                    setError('Failed to export data.');
                }
            };

            const handleExport = () => {
                if (!allPatientData || allPatientData.length === 0) {
                    alert('No patient data to export.');
                    return;
                }
                
                if (allPatientData.length === 1) {
                    performExport(allPatientData[0]);
                } else {
                    setIsExportModalOpen(true);
                }
            };
            
            const handleSelectAndExport = (section) => {
                performExport(section);
                setIsExportModalOpen(false);
            };

            const handlePatientUpdate = useCallback((updatedPatient) => {
                setAllPatientData(currentAllData =>
                    currentAllData.map(section => ({
                        ...section,
                        patients: section.patients.map(p =>
                            p.id === updatedPatient.id ? updatedPatient : p
                        ),
                    }))
                );
            }, []);

            const handleClearAll = () => {
                const initialSelections = {};
                allPatientData.forEach((_, index) => {
                    initialSelections[index] = true; // Select all by default
                });
                setSelectionsToDelete(initialSelections);
                setIsConfirmModalOpen(true);
            };

            const performDeletion = () => {
                setAllPatientData(currentData => 
                    currentData.filter((_, index) => !selectionsToDelete[index])
                );
                setIsConfirmModalOpen(false);
                setSelectionsToDelete({}); // Reset for next time
            };
            
            const triggerFileInput = () => {
                fileInputRef.current?.click();
            };
            
            let cumulativePatientCount = 0;

            return (
                <div className="min-h-screen bg-[#003638] text-[#EAEFF0] font-sans">
                    <div className="max-w-md mx-auto p-4">
                        <header className="py-4">
                            <img src="cropped.png" alt="Pain app logo" className="mx-auto w-72 h-72" width="288" height="288" />
                        </header>

                        <main className="mt-6 space-y-6">
                            {isLoading && <p className="text-center text-lg text-[#66d1cc]">Processing file...</p>}
                            {error && <p className="text-center text-lg text-[#F56565] bg-red-500/20 p-3 rounded-lg">{error}</p>}
                            
                            {!isLoading && allPatientData.length === 0 && !error && (
                                <div className="text-center text-[#B8C0C1] mt-16 p-6 bg-[#184144] rounded-lg">
                                    <p className="text-xl">Welcome!</p>
                                    <p>Click "Import" to load patient data.</p>
                                </div>
                            )}

                            {allPatientData.map((patientData, index) => {
                                if (patientData.patients.length === 0) {
                                    return null;
                                }
                                
                                const startingIndex = cumulativePatientCount;
                                cumulativePatientCount += patientData.patients.length;

                                return (
                                    <div key={`${patientData.sectionHeader}-${index}`} className="bg-black/20 rounded-lg shadow-lg overflow-hidden border border-[#255356]">
                                         <h2 className="p-4 text-xl font-bold text-center text-white bg-[#184144]">
                                            {patientData.sectionHeader}
                                         </h2>
                                        <div className="p-4 space-y-3">
                                            {patientData.patients.map((patient, patientIndex) => (
                                                <PatientAccordion
                                                    key={patient.id}
                                                    patient={patient}
                                                    patientNumber={startingIndex + patientIndex + 1}
                                                    onUpdate={handlePatientUpdate}
                                                />
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}
                        </main>
                        
                        <footer className="mt-8 pt-6 border-t border-[#255356]">
                            <div className="flex justify-center space-x-2 flex-wrap gap-2">
                                <button
                                    onClick={triggerFileInput}
                                    className="flex items-center justify-center px-4 py-3 bg-[#246364] hover:bg-[#1e5051] text-white font-semibold rounded-lg shadow-md transition-transform transform hover:scale-105"
                                    aria-label="Import XLSX file"
                                >
                                    <UploadIcon />
                                    <span className="ml-2 hidden sm:inline">Import</span>
                                </button>
                                <input
                                    type="file"
                                    ref={fileInputRef}
                                    onChange={handleFileImport}
                                    className="hidden"
                                    accept=".xlsx"
                                />
                                <button
                                    onClick={handleExport}
                                    disabled={allPatientData.length === 0}
                                    className="flex items-center justify-center px-4 py-3 bg-[#2F855A] hover:bg-[#276c4a] text-white font-semibold rounded-lg shadow-md transition-transform transform hover:scale-105 disabled:bg-[#4a6566] disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                                    aria-label="Export data to XLSX file"
                                >
                                    <DownloadIcon />
                                    <span className="ml-2 hidden sm:inline">Export</span>
                                </button>
                                <button
                                    onClick={handleClearAll}
                                    disabled={allPatientData.length === 0}
                                    className="flex items-center justify-center px-4 py-3 bg-[#E53E3E] hover:bg-[#C53030] text-white font-semibold rounded-lg shadow-md transition-transform transform hover:scale-105 disabled:bg-[#4a6566] disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                                    aria-label="Clear all data"
                                >
                                    <TrashIcon />
                                    <span className="ml-2 hidden sm:inline">Clear All</span>
                                </button>
                                {deferredPrompt && (
                                    <button
                                        onClick={handleInstallClick}
                                        className="flex items-center justify-center px-4 py-3 bg-[#6B46C1] hover:bg-[#553C9A] text-white font-semibold rounded-lg shadow-md transition-transform transform hover:scale-105"
                                        aria-label="Install application"
                                    >
                                        <InstallIcon />
                                        <span className="ml-2 hidden sm:inline">Install App</span>
                                    </button>
                                )}
                            </div>
                        </footer>
                    </div>
                    
                    {isExportModalOpen && (
                        <ExportModal
                            sections={allPatientData}
                            onSelect={handleSelectAndExport}
                            onClose={() => setIsExportModalOpen(false)}
                        />
                    )}
                    {isConfirmModalOpen && (
                        <ConfirmModal
                            title="Confirm Deletion"
                            sections={allPatientData}
                            selections={selectionsToDelete}
                            onSelectionChange={setSelectionsToDelete}
                            onConfirm={performDeletion}
                            onClose={() => setIsConfirmModalOpen(false)}
                        />
                    )}
                </div>
            );
        };

        // --- From index.tsx ---
        const rootElement = document.getElementById('root');
        if (!rootElement) {
          throw new Error("Could not find root element to mount to");
        }

        const root = ReactDOM.createRoot(rootElement);
        root.render(
          <React.StrictMode>
            <App />
          </React.StrictMode>
        );
    </script>
</body>
</html>
