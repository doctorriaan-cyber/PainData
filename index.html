
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>pain</title>
    <meta name="description" content="An application to import, view, edit, and export patient data from an XLSX file, designed for mobile use." />
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoicGFpbiIsInNob3J0X25hbWUiOiJwYWluIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwMDM2MzgiLCJ0aGVtZV9jb2xvciI6IiMwMDM2MzgiLCJkZXNjcmlwdGlvbiI6IkFuIGFwcGxpY2F0aW9uIHRvIGltcG9ydCwgdmlldywgZWRpdCwgYW5kIGV4cG9ydCBwYXRpZW50IGRhdGEuIiwiaWNvbnMiOlt7InNyYyI6ImNyb3BwZWQucG5nIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3BuZyIsInB1cnBvc2UiOiJhbnkgbWFza2FibGUifV19" />
    <meta name="theme-color" content="#003638" />
    <link rel="apple-touch-icon" href="cropped.png" />
    
    <!-- CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-[#003638]">
    <div id="root"></div>

    <script type="text/babel">
        // --- From components/icons.tsx ---
        const ImportIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M10 3a1 1 0 011 1v10.586l3.293-3.293a1 1 0 111.414 1.414l-5 5a1 1 0 01-1.414 0l-5-5a1 1 0 111.414-1.414L9 14.586V4a1 1 0 011-1z" clipRule="evenodd" />
            </svg>
        );

        const ExportIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M10 17a1 1 0 01-1-1V5.414l-3.293 3.293a1 1 0 11-1.414-1.414l5-5a1 1 0 011.414 0l5 5a1 1 0 11-1.414 1.414L11 5.414V16a1 1 0 01-1-1z" clipRule="evenodd" />
            </svg>
        );

        const InstallIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" className="w-5 h-5">
              <path d="M10.75 2.75a.75.75 0 0 0-1.5 0v8.614L6.295 8.235a.75.75 0 1 0-1.09 1.03l4.25 4.5a.75.75 0 0 0 1.09 0l4.25-4.5a.75.75 0 0 0-1.09-1.03l-2.955 3.129V2.75Z" />
              <path d="M3.5 12.75a.75.75 0 0 0-1.5 0v2.5A2.75 2.75 0 0 0 4.75 18h10.5A2.75 2.75 0 0 0 18 15.25v-2.5a.75.75 0 0 0-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5Z" />
            </svg>
        );

        const ChevronDownIcon = ({ isOpen }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={`h-6 w-6 transform transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
            </svg>
        );

        const CloseIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
        );

        const TrashIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" />
            </svg>
        );

        const WarningIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-12 w-12 text-yellow-400 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
        );
        
        const CautionIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
            </svg>
        );
        
        const BurgerMenuIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
        );

        const BackIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
            </svg>
        );

        // --- Global constants ---
        const initialStatsData = {
            totalPatients: 0,
            patientsByHospital: {},
            patientsByDoctor: {},
            sedationTypes: { 'Deep': 0, 'Awake': 0 },
            bmiStats: { over35: 0, under35: 0, highestBmi: null },
            ageStats: { over70: 0, under70: 0, oldestPatient: null },
            longestTheaterTime: null,
        };

        const statCategories = {
            totalPatients: 'Total Patients',
            patientsByHospital: 'Hospital Breakdown',
            patientsByDoctor: 'Doctor Breakdown',
            sedationTypes: 'Sedation Types',
            bmiStats: 'BMI Statistics',
            ageStats: 'Age Statistics',
            longestTheaterTime: 'Longest Theater Time',
        };

        // --- From services/xlsxService.ts ---
        const getCellValue = (worksheet, address) => {
          const cell = worksheet[address];
          if (!cell) return '';

          if (cell.t === 'd' && cell.v instanceof Date) {
            const date = cell.v;
            if (!isNaN(date.getTime())) {
              const hours = String(date.getUTCHours()).padStart(2, '0');
              const minutes = String(date.getUTCMinutes()).padStart(2, '0');
              return `${hours}:${minutes}`;
            }
          }

          if (cell.w) {
            return cell.w;
          }
          
          return cell.v !== null && cell.v !== undefined ? String(cell.v) : '';
        };

        const parsePatientData = async (file) => {
            const data = await file.arrayBuffer();
            const workbook = XLSX.read(data, { cellDates: true });
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];

            // Doctor Name from P2: everything before the first comma.
            const p2RawValue = getCellValue(worksheet, 'P2') || '';
            const doctorName = p2RawValue.split(',')[0].trim() || 'Unknown Doctor';
            
            // Hospital Name from P4: the first word of the cell's content.
            const p4RawValue = getCellValue(worksheet, 'P4') || '';
            const hospitalName = p4RawValue.split(' ')[0].trim() || 'Unknown Hospital';
            
            // Date from P4: Look for a date-like pattern in the cell.
            // The previous logic incorrectly used the first word as the date.
            const dateRegex = /(\d{4}-\d{2}-\d{2}|\d{2}\/\d{2}\/\d{4})/;
            const dateMatch = p4RawValue.match(dateRegex);
            const date = dateMatch ? dateMatch[0] : '';
            
            const sectionHeader = [doctorName, hospitalName].filter(Boolean).join(', ');

            const patients = [];
            let patientIndex = 0;

            while (true) {
                const startRow = patientIndex * 12 + 1;
                const nameCellAddress = `M${startRow}`;
                const patientName = getCellValue(worksheet, nameCellAddress);

                if (!patientName) {
                    break;
                }

                const notes = [];
                for (let i = 0; i < 7; i++) {
                    notes.push(getCellValue(worksheet, `M${startRow + 1 + i}`));
                }

                const rawKetamineAmount = getCellValue(worksheet, `N${startRow + 10}`);

                const patient = {
                    id: `p-${file.name.replace(/\W/g, '_')}-${patientIndex}`,
                    name: patientName,
                    age: getCellValue(worksheet, `N${startRow}`),
                    procedure: getCellValue(worksheet, `M${startRow + 8}`),
                    inTime: getCellValue(worksheet, `K${startRow + 3}`),
                    outTime: getCellValue(worksheet, `K${startRow + 4}`),
                    weight: getCellValue(worksheet, `K${startRow + 5}`),
                    height: getCellValue(worksheet, `K${startRow + 6}`),
                    sedationType: getCellValue(worksheet, `K${startRow + 7}`) || 'Deep',
                    tci: getCellValue(worksheet, `K${startRow + 8}`),
                    notes: notes,
                    ketamineAmount: rawKetamineAmount === '0' ? '' : rawKetamineAmount,
                    originalRow: startRow,
                    caution: false,
                    penicillinAllergy: false,
                };

                patients.push(patient);
                patientIndex++;
            }

            return { sectionHeader, patients, doctorName, hospitalName, date };
        };

        const exportPatientData = (patients, fileName = 'pain_data_export.xlsx') => {
            const wb = XLSX.utils.book_new();
            const ws = {};

            patients.forEach(patient => {
                const r = patient.originalRow;
                
                const addCell = (address, value) => {
                    if (value === null || value === undefined || value === '') return;
                    const cell = { t: 's', v: String(value) };
                    ws[address] = cell;
                };

                addCell(`M${r}`, patient.name);
                addCell(`N${r}`, patient.age);
                addCell(`K${r + 3}`, patient.inTime);
                addCell(`K${r + 4}`, patient.outTime);
                addCell(`K${r + 5}`, patient.weight);
                addCell(`K${r + 6}`, patient.height);
                addCell(`K${r + 7}`, patient.sedationType);
                addCell(`K${r + 8}`, patient.tci);
                addCell(`M${r + 8}`, patient.procedure);
                addCell(`N${r + 10}`, patient.ketamineAmount || '0');

                patient.notes.forEach((note, index) => {
                    addCell(`M${r + 1 + index}`, note);
                });
            });

            if (Object.keys(ws).length > 0) {
                const range = { s: { c: 10000, r: 10000 }, e: { c: 0, r: 0 } };
                Object.keys(ws).forEach(address => {
                    if (address === '!ref') return;
                    const cellRef = XLSX.utils.decode_cell(address);
                    range.s.c = Math.min(range.s.c, cellRef.c);
                    range.s.r = Math.min(range.s.r, cellRef.r);
                    range.e.c = Math.max(range.e.c, cellRef.c);
                    range.e.r = Math.max(range.e.r, cellRef.r);
                });
                ws['!ref'] = XLSX.utils.encode_range(range);
            } else {
                ws['!ref'] = 'A1';
            }
            
            XLSX.utils.book_append_sheet(wb, ws, "Patient Data");
    
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/octet-stream' });

            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        };
        
        // --- Time and BMI calculation helpers (moved for global access) ---
        const parseTime = (timeStr) => {
            if (!timeStr || !/^\d{1,2}:\d{2}$/.test(timeStr)) {
                return null;
            }
            const [hours, minutes] = timeStr.split(':').map(Number);
            if (hours >= 24 || minutes >= 60) {
                return null;
            }
            return hours * 60 + minutes;
        };

        const formatTime = (totalMinutes) => {
            if (totalMinutes === null || isNaN(totalMinutes)) return '--:--';
            const hours = Math.floor(totalMinutes / 60) % 24;
            const minutes = totalMinutes % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        };

        const formatDuration = (totalMinutes) => {
            if (totalMinutes === null || isNaN(totalMinutes) || totalMinutes < 0) return 'N/A';
            if (totalMinutes === 0) return '0m';
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            let durationStr = '';
            if (hours > 0) durationStr += `${hours}h `;
            if (minutes > 0) durationStr += `${minutes}m`;
            return durationStr.trim();
        };
        
        const calculateBmi = (weight, height) => {
            const weightNum = parseFloat(weight);
            const heightNum = parseFloat(height);
            if (weightNum > 0 && heightNum > 0) {
                const heightInMeters = heightNum;
                return (weightNum / (heightInMeters * heightInMeters));
            }
            return null;
        };

        // --- From components/ConfirmModal.tsx ---
        const ConfirmModal = ({ title, message, onConfirm, onClose, sections, selections, onSelectionChange }) => {
            const hasSelections = sections && selections && onSelectionChange;
            
            const handleCheckboxChange = (index) => {
                onSelectionChange({
                    ...selections,
                    [index]: !selections[index],
                });
            };

            const numSelected = hasSelections ? Object.values(selections).filter(Boolean).length : 0;
            const isConfirmDisabled = hasSelections && numSelected === 0;

            return (
                <div 
                    className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50"
                    aria-modal="true"
                    role="dialog"
                    onClick={onClose}
                >
                    <div 
                        className="bg-[#184144] rounded-lg shadow-2xl w-full max-w-sm border border-[#255356] text-left"
                        onClick={(e) => e.stopPropagation()}
                    >
                        <div className="p-6">
                            <div className="text-center">
                                <WarningIcon />
                                <h2 className="text-xl font-bold text-[#F56565] mb-2">{title}</h2>
                            </div>
                            {hasSelections ? (
                                <div className="mt-4 space-y-3 max-h-60 overflow-y-auto">
                                    <p className="text-[#B8C0C1] mb-3">Select the sections you want to delete. Patient numbering will be recalculated.</p>
                                    {sections.map((section, index) => (
                                        <label key={`${section.sectionHeader}-${index}`} className="flex items-center p-3 bg-[#255356] rounded-md cursor-pointer hover:bg-[#246364]">
                                            <input 
                                                type="checkbox"
                                                checked={!!selections[index]}
                                                onChange={() => handleCheckboxChange(index)}
                                                className="h-5 w-5 rounded bg-[#003638] border-[#35686b] text-[#246364] focus:ring-[#246364] focus:ring-offset-[#184144]"
                                            />
                                            <span className="ml-3 text-[#EAEFF0] truncate" title={section.sectionHeader}>{section.sectionHeader}</span>
                                        </label>
                                    ))}
                                </div>
                            ) : (
                                <p className="text-[#B8C0C1] text-center">{message}</p>
                            )}
                        </div>
                        <div className="p-4 bg-[#123133]/50 flex justify-center space-x-4 rounded-b-lg">
                             <button
                                onClick={onClose}
                                className="px-6 py-2 bg-[#4a6566] hover:bg-[#3e5556] text-white font-semibold rounded-lg w-full"
                            >
                                Cancel
                            </button>
                            <button
                                onClick={onConfirm}
                                disabled={isConfirmDisabled}
                                className="px-6 py-2 bg-[#E53E3E] hover:bg-[#C53030] text-white font-semibold rounded-lg w-full disabled:bg-red-800 disabled:cursor-not-allowed disabled:opacity-70"
                            >
                                Confirm
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- From components/ClearStatsModal.tsx (New Component) ---
        const ClearStatsModal = ({ onClose, onConfirm, selections, onSelectionChange, statCategories }) => {
            const allSelected = Object.values(selections).every(Boolean);
            const numSelected = Object.values(selections).filter(Boolean).length;
            const isConfirmDisabled = numSelected === 0;

            const handleSelectAll = () => {
                const newSelections = {};
                const targetValue = !allSelected;
                for (const key in selections) {
                    newSelections[key] = targetValue;
                }
                onSelectionChange(newSelections);
            };

            const handleCheckboxChange = (key) => {
                onSelectionChange({
                    ...selections,
                    [key]: !selections[key],
                });
            };

            return (
                <div
                    className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50"
                    aria-modal="true"
                    role="dialog"
                    onClick={onClose}
                >
                    <div
                        className="bg-[#184144] rounded-lg shadow-2xl w-full max-w-sm border border-[#255356] text-left"
                        onClick={(e) => e.stopPropagation()}
                    >
                        <div className="p-6">
                            <div className="text-center">
                                <WarningIcon />
                                <h2 className="text-xl font-bold text-[#F56565] mb-2">Select Stats to Clear</h2>
                            </div>
                            <div className="mt-4 space-y-3 max-h-60 overflow-y-auto">
                                <p className="text-[#B8C0C1] mb-3">Select the stats you want to permanently clear.</p>
                                <label className="flex items-center p-3 bg-[#255356] rounded-md cursor-pointer hover:bg-[#246364] font-semibold">
                                    <input
                                        type="checkbox"
                                        checked={allSelected}
                                        onChange={handleSelectAll}
                                        className="h-5 w-5 rounded bg-[#003638] border-[#35686b] text-[#246364] focus:ring-[#246364] focus:ring-offset-[#184144]"
                                    />
                                    <span className="ml-3 text-[#EAEFF0]">Select All</span>
                                </label>
                                <hr className="border-[#35686b]" />
                                {Object.entries(statCategories).map(([key, name]) => (
                                    <label key={key} className="flex items-center p-3 bg-[#255356] rounded-md cursor-pointer hover:bg-[#246364]">
                                        <input
                                            type="checkbox"
                                            checked={!!selections[key]}
                                            onChange={() => handleCheckboxChange(key)}
                                            className="h-5 w-5 rounded bg-[#003638] border-[#35686b] text-[#246364] focus:ring-[#246364] focus:ring-offset-[#184144]"
                                        />
                                        <span className="ml-3 text-[#EAEFF0] truncate">{name}</span>
                                    </label>
                                ))}
                            </div>
                        </div>
                        <div className="p-4 bg-[#123133]/50 flex justify-center space-x-4 rounded-b-lg">
                            <button
                                onClick={onClose}
                                className="px-6 py-2 bg-[#4a6566] hover:bg-[#3e5556] text-white font-semibold rounded-lg w-full"
                            >
                                Cancel
                            </button>
                            <button
                                onClick={onConfirm}
                                disabled={isConfirmDisabled}
                                className="px-6 py-2 bg-[#E53E3E] hover:bg-[#C53030] text-white font-semibold rounded-lg w-full disabled:bg-red-800 disabled:cursor-not-allowed disabled:opacity-70"
                            >
                                Clear Selected
                            </button>
                        </div>
                    </div>
                </div>
            );
        };


        // --- From components/ExportModal.tsx ---
        const ExportModal = ({ sections, onSelect, onClose }) => {
            return (
                <div 
                    className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50"
                    aria-modal="true"
                    role="dialog"
                    onClick={onClose}
                >
                    <div 
                        className="bg-[#184144] rounded-lg shadow-2xl w-full max-w-sm border border-[#255356]"
                        onClick={(e) => e.stopPropagation()}
                    >
                        <div className="flex justify-between items-center p-4 border-b border-[#35686b]">
                            <h2 className="text-xl font-bold text-[#EAEFF0]">Select Section to Export</h2>
                            <button onClick={onClose} className="text-[#B8C0C1] hover:text-[#EAEFF0]">
                                <CloseIcon />
                            </button>
                        </div>
                        <div className="p-4 max-h-80 overflow-y-auto">
                            <p className="text-[#B8C0C1] mb-4">Choose which imported file you would like to export.</p>
                            <div className="space-y-3">
                                {sections.map((section, index) => (
                                    <button
                                        key={`${section.sectionHeader}-${index}`}
                                        onClick={() => onSelect(section)}
                                        className="w-full text-left px-4 py-3 bg-[#255356] hover:bg-[#246364] text-[#EAEFF0] rounded-md transition-colors duration-200"
                                    >
                                        {section.sectionHeader}
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div className="p-4 border-t border-[#35686b] text-right">
                             <button
                                onClick={onClose}
                                className="px-4 py-2 bg-[#4a6566] hover:bg-[#3e5556] text-white font-semibold rounded-lg"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- From components/CustomSelect.tsx ---
        const CustomSelect = ({ label, options, value, onChange, id }) => {
            const [isOpen, setIsOpen] = React.useState(false);
            const selectRef = React.useRef(null);

            const handleSelect = (option) => {
                onChange(option);
                setIsOpen(false);
            };

            React.useEffect(() => {
                const handleClickOutside = (event) => {
                    if (selectRef.current && !selectRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => {
                    document.removeEventListener("mousedown", handleClickOutside);
                };
            }, []);
            
            const DropdownArrowIcon = ({ isOpen }) => (
                <svg className={`h-5 w-5 text-[#B8C0C1] transform transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fillRule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clipRule="evenodd" />
                </svg>
            );

            return (
                <div className="relative" ref={selectRef}>
                    <label htmlFor={id} className="block text-sm font-medium text-[#B8C0C1] mb-1">{label}</label>
                    <button
                        type="button"
                        id={id}
                        onClick={() => setIsOpen(!isOpen)}
                        className="w-full bg-[#255356] border border-[#35686b] rounded-md px-3 py-2 text-[#EAEFF0] focus:ring-2 focus:ring-[#246364] focus:border-[#246364] flex justify-between items-center text-left"
                        aria-haspopup="listbox"
                        aria-expanded={isOpen}
                    >
                        <span>{value}</span>
                        <DropdownArrowIcon isOpen={isOpen} />
                    </button>
                    {isOpen && (
                        <div 
                            className="absolute z-10 mt-1 w-full bg-[#184144] border border-[#35686b] rounded-md shadow-lg max-h-60 overflow-auto focus:outline-none"
                            role="listbox"
                        >
                            {options.map((option) => (
                                <div
                                    key={option}
                                    onClick={() => handleSelect(option)}
                                    className="cursor-pointer select-none relative py-2 pl-3 pr-9 text-[#EAEFF0] hover:bg-[#246364]"
                                    role="option"
                                    aria-selected={value === option}
                                >
                                    <span className={`block truncate ${value === option ? 'font-semibold' : 'font-normal'}`}>{option}</span>
                                    {value === option ? (
                                        <span className="absolute inset-y-0 right-0 flex items-center pr-4 text-[#66d1cc]">
                                            <svg className="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                                            </svg>
                                        </span>
                                    ) : null}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- From components/PatientAccordion.tsx ---
        const AutosizeTextarea = (props) => {
            const textareaRef = React.useRef(null);
            const { value } = props;

            React.useLayoutEffect(() => {
                const textarea = textareaRef.current;
                if (textarea) {
                    textarea.style.height = 'auto';
                    textarea.style.height = `${textarea.scrollHeight}px`;
                }
            }, [value]);

            return (
                <textarea
                    ref={textareaRef}
                    rows={1}
                    className="w-full bg-transparent px-3 py-2 text-[#EAEFF0] focus:ring-2 focus:ring-inset focus:ring-[#246364] resize-none overflow-hidden focus:outline-none"
                    {...props}
                />
            );
        };
        
        const InputField = ({ label, name, value, onChange, id }) => {
            const labelRef = React.useRef(null);
            const wrapperRef = React.useRef(null);

            React.useLayoutEffect(() => {
                const labelElement = labelRef.current;
                const wrapperElement = wrapperRef.current;
                if (!labelElement || !wrapperElement) return;

                const resizeText = () => {
                    const containerWidth = wrapperElement.clientWidth;
                    // Reset font size to be controlled by the CSS class for accurate measurement
                    labelElement.style.fontSize = '';
                    const baseFontSize = parseFloat(window.getComputedStyle(labelElement).fontSize);
                    
                    // Only resize if text overflows its container
                    if (labelElement.scrollWidth > containerWidth) {
                        const newSize = (containerWidth / labelElement.scrollWidth) * baseFontSize;
                        // Set a minimum font size to maintain readability
                        labelElement.style.fontSize = `${Math.max(newSize, 9)}px`;
                    }
                };
                
                resizeText();

                const observer = new ResizeObserver(resizeText);
                observer.observe(wrapperElement);

                return () => {
                    observer.disconnect();
                };
            }, [label]);

            return (
                <div>
                    <div ref={wrapperRef} className="h-5 flex items-end mb-1">
                        <label 
                            htmlFor={id} 
                            ref={labelRef} 
                            className="text-sm font-medium text-[#B8C0C1] whitespace-nowrap"
                            title={label}
                        >
                            {label}
                        </label>
                    </div>
                    <input
                        type="text"
                        id={id}
                        name={name}
                        value={value}
                        onChange={onChange}
                        className="w-full bg-[#255356] border border-[#35686b] rounded-md px-3 py-2 text-[#EAEFF0] focus:ring-2 focus:ring-[#246364] focus:border-[#246364]"
                    />
                </div>
            );
        };

        const PatientAccordion = ({ patient, onUpdate, patientNumber }) => {
            const [isOpen, setIsOpen] = React.useState(false);
            const accordionRef = React.useRef(null);

            React.useEffect(() => {
                if (isOpen) {
                    const timer = setTimeout(() => {
                        accordionRef.current?.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start',
                        });
                    }, 500);
                    return () => clearTimeout(timer);
                }
            }, [isOpen]);

            const handleInputChange = (e) => {
                const { name, value, type, checked } = e.target;
                const newValue = type === 'checkbox' ? checked : value;
                onUpdate({ ...patient, [name]: newValue });
            };
            
            const handleSedationChange = (newValue) => {
                onUpdate({ ...patient, sedationType: newValue });
            };

            const handleNoteChange = (index, value) => {
                const newNotes = [...patient.notes];
                newNotes[index] = value;
                onUpdate({ ...patient, notes: newNotes });
            };

            const isComplete = React.useMemo(() => {
                return !!(
                    patient.inTime &&
                    patient.outTime &&
                    patient.weight &&
                    patient.height &&
                    patient.tci
                );
            }, [patient.inTime, patient.outTime, patient.weight, patient.height, patient.tci]);

            const { name, calculatedBmi, maxWeight } = React.useMemo(() => {
                const bmi = calculateBmi(patient.weight, patient.height);
                let maxW = null;
                
                if (bmi && bmi >= 35) {
                    const heightNum = parseFloat(patient.height);
                    if(heightNum > 0) {
                        const heightInMeters = heightNum;
                        maxW = Math.round(34.5 * heightInMeters * heightInMeters);
                    }
                }

                return {
                    name: patient.name || 'Unnamed Patient',
                    calculatedBmi: bmi ? bmi.toFixed(1) : null,
                    maxWeight: maxW,
                };
            }, [patient.name, patient.weight, patient.height]);

            const { totalTime, timePlus30, timePlus45 } = React.useMemo(() => {
                const inTimeMinutes = parseTime(patient.inTime);
                const outTimeMinutes = parseTime(patient.outTime);

                let totalDuration = null;
                if (inTimeMinutes !== null && outTimeMinutes !== null) {
                    let duration = outTimeMinutes - inTimeMinutes;
                    if (duration < 0) { // Handles overnight case
                        duration += 24 * 60;
                    }
                    totalDuration = formatDuration(duration);
                }

                const plus30 = inTimeMinutes !== null ? formatTime(inTimeMinutes + 30) : '--:--';
                const plus45 = inTimeMinutes !== null ? formatTime(inTimeMinutes + 45) : '--:--';

                return {
                    totalTime: totalDuration || 'N/A',
                    timePlus30: plus30,
                    timePlus45: plus45,
                };
            }, [patient.inTime, patient.outTime]);
            
            const headerDetailsItems = [];
            if (patient.age) {
                headerDetailsItems.push(
                    <span key="age">Age: <strong className="font-bold text-white">{patient.age}</strong></span>
                );
            }
            if (patient.weight) {
                headerDetailsItems.push(
                    <span key="weight">W: <strong className="font-bold text-white">{patient.weight}</strong> kg</span>
                );
            }
            if (patient.height) {
                headerDetailsItems.push(
                    <span key="height">H: <strong className="font-bold text-white">{patient.height}</strong> m</span>
                );
            }
            if (calculatedBmi) {
                const isBmiHigh = parseFloat(calculatedBmi) >= 35;
                headerDetailsItems.push(
                    <span key="bmi" className={isBmiHigh ? 'underline' : ''}>
                        BMI: <strong className="font-bold text-white">{calculatedBmi}</strong>
                    </span>
                );
            }

            const weightLabel = maxWeight ? `Weight (kg), Max ${maxWeight}kg` : 'Weight (kg)';

            return (
                <div className="bg-[#184144] rounded-lg shadow-lg overflow-hidden">
                    <button
                        onClick={() => setIsOpen(!isOpen)}
                        className={`w-full flex justify-between items-center p-4 text-left focus:outline-none transition-colors duration-200 ${patient.caution ? 'bg-red-400/40 hover:bg-red-400/50 focus:bg-red-400/40' : 'hover:bg-[#255356] focus:bg-[#255356]'}`}
                        aria-expanded={isOpen}
                        ref={accordionRef}
                    >
                        <div className="flex items-start min-w-0">
                            <div className="flex flex-col items-center mr-3 flex-shrink-0 w-8">
                                <span
                                    className={`w-3 h-3 rounded-full ${isComplete ? 'bg-[#48BB78]' : 'bg-[#F56565]'}`}
                                    title={isComplete ? 'All fields complete' : 'Missing required data'}
                                ></span>
                                {patientNumber && (
                                    <span className="text-xl font-bold text-[#B8C0C1] mt-1">{patientNumber}</span>
                                )}
                                <div className="mt-1 h-7 flex items-center justify-center" title={patient.penicillinAllergy ? "Penicillin Allergy" : ""}>
                                    {patient.penicillinAllergy && <span className="text-xl">ðŸ’Š</span>}
                                </div>
                            </div>
                            <div className="flex flex-col min-w-0">
                                <span className="truncate font-semibold text-lg text-[#EAEFF0]" title={name}>{name}</span>
                                {headerDetailsItems.length > 0 && (
                                    <span className="text-sm text-[#B8C0C1]">
                                        {headerDetailsItems.map((item, index) => (
                                            <React.Fragment key={index}>
                                                {item}
                                                {index < headerDetailsItems.length - 1 && ', '}
                                            </React.Fragment>
                                        ))}
                                    </span>
                                )}
                                {patient.procedure && (
                                    <span className="text-sm text-[#B8C0C1] mt-1 truncate" title={patient.procedure}>
                                        {patient.procedure}
                                    </span>
                                )}
                            </div>
                        </div>
                        <ChevronDownIcon isOpen={isOpen} />
                    </button>
                    <div className={`grid transition-all duration-500 ease-in-out ${isOpen ? 'grid-rows-[1fr]' : 'grid-rows-[0fr]'}`}>
                        <div className="overflow-hidden">
                            <div className="p-4 border-t border-[#255356] space-y-4">
                                <div className="grid grid-cols-2 gap-4">
                                    <InputField id={`weight-${patient.id}`} label={weightLabel} name="weight" value={patient.weight} onChange={handleInputChange} />
                                    <InputField id={`height-${patient.id}`} label="Height (m)" name="height" value={patient.height} onChange={handleInputChange} />
                                    <InputField id={`inTime-${patient.id}`} label="In Time" name="inTime" value={patient.inTime} onChange={handleInputChange} />
                                    <InputField id={`outTime-${patient.id}`} label="Out Time" name="outTime" value={patient.outTime} onChange={handleInputChange} />
                                    
                                    <div className="col-span-2 grid grid-cols-2 gap-4 items-end">
                                        <div className="grid grid-cols-2 gap-4">
                                            <InputField id={`tci-${patient.id}`} label="TCI" name="tci" value={patient.tci} onChange={handleInputChange} />
                                            <InputField id={`ketamineAmount-${patient.id}`} label="Ketamine" name="ketamineAmount" value={patient.ketamineAmount} onChange={handleInputChange} />
                                        </div>
                                        <div className="text-sm text-[#B8C0C1] pl-2 pb-1 space-y-1">
                                            <div>Total time: <strong className="font-semibold text-[#EAEFF0]">{totalTime}</strong></div>
                                            <div className="text-xs">
                                                30min: <strong className="font-semibold text-[#EAEFF0]">{timePlus30}</strong> | 45min: <strong className="font-semibold text-[#EAEFF0]">{timePlus45}</strong>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="col-span-2 grid grid-cols-3 items-end gap-4">
                                        <CustomSelect
                                            id={`sedationType-${patient.id}`}
                                            label="Sedation Type"
                                            options={['Deep', 'Awake']}
                                            value={patient.sedationType}
                                            onChange={handleSedationChange}
                                        />
                                        <div className="flex flex-col items-center">
                                            <label htmlFor={`caution-${patient.id}`} className="block text-sm font-medium text-[#B8C0C1] mb-1">Caution</label>
                                            <input
                                                type="checkbox"
                                                id={`caution-${patient.id}`}
                                                name="caution"
                                                checked={!!patient.caution}
                                                onChange={handleInputChange}
                                                className="appearance-none h-8 w-8 bg-[#255356] border border-[#35686b] rounded-md cursor-pointer focus:ring-2 focus:ring-offset-2 focus:ring-offset-[#184144] focus:ring-[#246364] checked:bg-[#246364] checked:bg-[url('data:image/svg+xml,%3Csvg%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22white%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M12.207%204.793a1%201%200%20010%201.414l-5%205a1%201%200%2001-1.414%200l-2-2a1%201%200%20011.414-1.414L6.5%209.086l4.293-4.293a1%201%200%20011.414%200z%22%2F%3E%3C%2Fsvg%3E')] checked:bg-center checked:bg-no-repeat"
                                            />
                                        </div>
                                        <div className="flex flex-col items-center">
                                            <label htmlFor={`penicillinAllergy-${patient.id}`} className="block text-sm font-medium text-[#B8C0C1] mb-1">Penicillin Allergy</label>
                                            <input
                                                type="checkbox"
                                                id={`penicillinAllergy-${patient.id}`}
                                                name="penicillinAllergy"
                                                checked={!!patient.penicillinAllergy}
                                                onChange={handleInputChange}
                                                className="appearance-none h-8 w-8 bg-[#255356] border border-[#35686b] rounded-md cursor-pointer focus:ring-2 focus:ring-offset-2 focus:ring-offset-[#184144] focus:ring-[#246364] checked:bg-[#246364] checked:bg-[url('data:image/svg+xml,%3Csvg%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22white%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M12.207%204.793a1%201%200%20010%201.414l-5%205a1%201%200%2001-1.414%200l-2-2a1%201%200%20011.414-1.414L6.5%209.086l4.293-4.293a1%201%200%20011.414%200z%22%2F%3E%3C%2Fsvg%3E')] checked:bg-center checked:bg-no-repeat"
                                            />
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-[#B8C0C1] mb-1">Patient Notes</label>
                                    <div className="bg-[#255356] border border-[#35686b] rounded-md overflow-hidden">
                                        {patient.notes.map((note, index) => (
                                            <div key={index} className={index > 0 ? 'border-t border-[#35686b]' : ''}>
                                                <AutosizeTextarea
                                                    value={note}
                                                    onChange={(e) => handleNoteChange(index, e.target.value)}
                                                    placeholder={`Note ${index + 1}`}
                                                />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // --- From components/StatsPage.tsx ---
        const StatsPage = ({ stats, setStats, onBack, isEditing, setIsEditing }) => {
            const importStatsRef = React.useRef(null);
            const [isConfirmClearOpen, setIsConfirmClearOpen] = React.useState(false);
            const [isSelectClearOpen, setIsSelectClearOpen] = React.useState(false);
            const [selectionsToClear, setSelectionsToClear] = React.useState(
                Object.keys(statCategories).reduce((acc, key) => ({ ...acc, [key]: false }), {})
            );
            
            const inputClass = "w-full bg-[#255356] border border-[#35686b] rounded-md px-2 py-1 text-[#EAEFF0] focus:ring-2 focus:ring-[#246364] focus:border-[#246364]";
            
            const getPercentage = (count, total) => total > 0 ? ((count / total) * 100).toFixed(1) + '%' : '0.0%';

            const handleValueChange = (path, value) => {
                setStats(prev => {
                    const newStats = JSON.parse(JSON.stringify(prev));
                    let current = newStats;
                    for (let i = 0; i < path.length - 1; i++) {
                        current = current[path[i]];
                    }
                    current[path[path.length - 1]] = value;
                    return newStats;
                });
            };

            const handleNameChange = (category, oldName, newName) => {
                if (!newName || oldName === newName) return;
                setStats(prev => {
                    const newStats = JSON.parse(JSON.stringify(prev));
                    const value = newStats[category][oldName];
                    delete newStats[category][oldName];
                    newStats[category][newName] = value;
                    return newStats;
                });
            };

            const handleExportStats = () => {
                try {
                    const jsonString = JSON.stringify(stats, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'patient_stats_export.json';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                } catch (error) {
                    console.error("Failed to export stats:", error);
                    alert("An error occurred while exporting the stats.");
                }
            };
            
            const triggerStatsImport = () => {
                importStatsRef.current?.click();
            };

            const handleImportStats = (event) => {
                const file = event.target.files?.[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const importedStats = JSON.parse(text);
                        // A more robust app might validate the imported structure here
                        setStats(importedStats);
                        alert("Stats imported successfully!");
                    } catch (error) {
                        console.error("Failed to import stats:", error);
                        alert("Failed to import stats. Please ensure it is a valid JSON file.");
                    } finally {
                        if (importStatsRef.current) {
                            importStatsRef.current.value = '';
                        }
                    }
                };
                reader.readAsText(file);
            };

            const handleOpenClearConfirm = () => {
                // Reset selections when opening the flow
                setSelectionsToClear(Object.keys(statCategories).reduce((acc, key) => ({ ...acc, [key]: false }), {}));
                setIsConfirmClearOpen(true);
            };

            const handleProceedToSelect = () => {
                setIsConfirmClearOpen(false);
                setIsSelectClearOpen(true);
            };

            const handleConfirmClear = () => {
                setStats(prev => {
                    const newStats = JSON.parse(JSON.stringify(prev));
                    for (const key in selectionsToClear) {
                        if (selectionsToClear[key]) {
                            newStats[key] = initialStatsData[key];
                        }
                    }
                    return newStats;
                });
                setIsSelectClearOpen(false);
            };


            const EditableField = ({ value, path, type = 'text', isName = false, category, oldName }) => {
                if (isEditing) {
                    const commonProps = {
                        type: type,
                        className: inputClass,
                    };
                    if (isName) {
                        return (
                            <input
                                {...commonProps}
                                defaultValue={value}
                                onBlur={(e) => handleNameChange(category, oldName, e.target.value)}
                            />
                        );
                    } else {
                        return (
                             <input
                                {...commonProps}
                                value={value}
                                onChange={(e) => {
                                    const newValue = type === 'number' ? (parseInt(e.target.value, 10) || 0) : e.target.value;
                                    handleValueChange(path, newValue);
                                }}
                            />
                        );
                    }
                }
                return <span className="font-bold">{value}</span>;
            };

            const totalPatients = stats.totalPatients || 0;
            const totalHospitalPatients = Object.values(stats.patientsByHospital).reduce((sum, count) => sum + (count || 0), 0);
            const totalDoctorPatients = Object.values(stats.patientsByDoctor).reduce((sum, count) => sum + (count || 0), 0);
            const totalSedationTypes = Object.values(stats.sedationTypes).reduce((sum, count) => sum + (count || 0), 0);
            const totalBmiPatients = (stats.bmiStats.under35 || 0) + (stats.bmiStats.over35 || 0);
            const totalAgePatients = (stats.ageStats.under70 || 0) + (stats.ageStats.over70 || 0);
            
            const breakdownData = [
                { key: 'patientsByHospital', title: 'Hospital Breakdown', data: stats.patientsByHospital, total: totalHospitalPatients },
                { key: 'patientsByDoctor', title: 'Doctor Breakdown', data: stats.patientsByDoctor, total: totalDoctorPatients },
                { key: 'sedationTypes', title: 'Sedation types', data: stats.sedationTypes, total: totalSedationTypes },
            ];


            return (
                <div className="min-h-screen bg-[#003638] text-[#EAEFF0] font-sans">
                    <div className="p-4 pb-28"> {/* Padding bottom to avoid overlap with fixed footer */}
                        <header className="flex justify-between items-center pb-4 mb-4 border-b border-[#255356]">
                            <button onClick={onBack} className="p-2 rounded-md hover:bg-[#255356]"><BackIcon /></button>
                            <h1 className="text-2xl font-bold text-white">Statistics</h1>
                            <button onClick={() => setIsEditing(!isEditing)} className="px-4 py-2 bg-[#246364] hover:bg-[#1e5051] text-white font-semibold rounded-lg">
                                {isEditing ? 'Save' : 'Edit'}
                            </button>
                        </header>
                        <main className="space-y-4">
                            {stats.totalPatients > 0 && (
                                <div className="bg-[#184144] p-4 rounded-lg">
                                    <h2 className="text-lg font-semibold text-center text-[#66d1cc]">Total patients</h2>
                                    <div className="text-center text-4xl font-bold mt-2">
                                        <EditableField value={totalPatients} path={['totalPatients']} type="number" />
                                    </div>
                                </div>
                            )}

                            {breakdownData.map(({ key, title, data, total }) => {
                                let entries = Object.entries(data);
                                if (entries.length === 0 || total === 0) return null;

                                if (key === 'patientsByHospital' || key === 'patientsByDoctor') {
                                    entries.sort(([, countA], [, countB]) => countB - countA);
                                }
                                
                                return (
                                    <div key={key} className="bg-[#184144] p-4 rounded-lg">
                                        <h2 className="text-lg font-semibold text-[#66d1cc]">{title}</h2>
                                        <div className="mt-2 space-y-2">
                                            {entries.map(([name, count]) => (
                                                <div key={name} className="grid grid-cols-3 items-center gap-2">
                                                    <EditableField value={name} isName={true} category={key} oldName={name} />
                                                    <div className="text-right">
                                                        <EditableField value={count} path={[key, name]} type="number" />
                                                    </div>
                                                    <div className="text-right text-[#B8C0C1]">{getPercentage(count, total)}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}
                            
                            {totalBmiPatients > 0 && (
                                <div className="bg-[#184144] p-4 rounded-lg">
                                    <h2 className="text-lg font-semibold text-[#66d1cc]">BMI</h2>
                                    <div className="mt-2 space-y-2">
                                        <div className="grid grid-cols-3 items-center gap-2">
                                            <span>BMI &lt; 35:</span>
                                            <div className="text-right"><EditableField value={stats.bmiStats.under35} path={['bmiStats', 'under35']} type="number" /></div>
                                            <div className="text-right text-[#B8C0C1]">{getPercentage(stats.bmiStats.under35, totalBmiPatients)}</div>
                                        </div>
                                        <div className="grid grid-cols-3 items-center gap-2">
                                            <span>BMI &ge; 35:</span>
                                            <div className="text-right"><EditableField value={stats.bmiStats.over35} path={['bmiStats', 'over35']} type="number" /></div>
                                            <div className="text-right text-[#B8C0C1]">{getPercentage(stats.bmiStats.over35, totalBmiPatients)}</div>
                                        </div>
                                    </div>
                                    {stats.bmiStats.highestBmi && (
                                        <div className="mt-4 pt-4 border-t border-[#255356]">
                                            <h3 className="font-semibold text-md text-[#B8C0C1]">Highest BMI Patient</h3>
                                            <p className="text-sm mt-2 leading-relaxed">
                                                Patient <strong className="text-white">{stats.bmiStats.highestBmi.patientName}</strong> had the highest BMI of <strong className="text-white">{stats.bmiStats.highestBmi.bmi.toFixed(1)}</strong> for procedure <strong>{stats.bmiStats.highestBmi.procedure || 'N/A'}</strong>. This was recorded on {stats.bmiStats.highestBmi.date} with <strong>{stats.bmiStats.highestBmi.doctorName}</strong> at <strong>{stats.bmiStats.highestBmi.hospitalName}</strong>.
                                            </p>
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            {totalAgePatients > 0 && (
                                <div className="bg-[#184144] p-4 rounded-lg">
                                    <h2 className="text-lg font-semibold text-[#66d1cc]">Age</h2>
                                    <div className="mt-2 space-y-2">
                                        <div className="grid grid-cols-3 items-center gap-2">
                                            <span>Age &lt; 70:</span>
                                            <div className="text-right"><EditableField value={stats.ageStats.under70} path={['ageStats', 'under70']} type="number" /></div>
                                            <div className="text-right text-[#B8C0C1]">{getPercentage(stats.ageStats.under70, totalAgePatients)}</div>
                                        </div>
                                        <div className="grid grid-cols-3 items-center gap-2">
                                            <span>Age &gt; 70:</span>
                                            <div className="text-right"><EditableField value={stats.ageStats.over70} path={['ageStats', 'over70']} type="number" /></div>
                                            <div className="text-right text-[#B8C0C1]">{getPercentage(stats.ageStats.over70, totalAgePatients)}</div>
                                        </div>
                                    </div>
                                    {stats.ageStats.oldestPatient && (
                                        <div className="mt-4 pt-4 border-t border-[#255356]">
                                            <h3 className="font-semibold text-md text-[#B8C0C1]">Oldest Patient</h3>
                                            <p className="text-sm mt-2 leading-relaxed">
                                                The oldest patient was <strong className="text-white">{stats.ageStats.oldestPatient.patientName}</strong> (Age: <strong className="text-white">{stats.ageStats.oldestPatient.age}</strong>).
                                                This was recorded on {stats.ageStats.oldestPatient.date || 'an unknown date'} for procedure <strong>{stats.ageStats.oldestPatient.procedure || 'N/A'}</strong> with <strong>{stats.ageStats.oldestPatient.doctorName}</strong> at <strong>{stats.ageStats.oldestPatient.hospitalName}</strong>.
                                            </p>
                                        </div>
                                    )}
                                </div>
                            )}

                            {stats.longestTheaterTime && (
                                <div className="bg-[#184144] p-4 rounded-lg">
                                    <h2 className="text-lg font-semibold text-[#66d1cc]">Longest theater time</h2>
                                    <div className="mt-2">
                                        <p className="text-sm leading-relaxed">
                                            <strong className="text-white">{stats.longestTheaterTime.patientName}</strong> had the longest time of <strong className="text-white">{formatDuration(stats.longestTheaterTime.duration)}</strong> for procedure <strong>{stats.longestTheaterTime.procedure || 'N/A'}</strong>.
                                            This was recorded on {stats.longestTheaterTime.date} with <strong>{stats.longestTheaterTime.doctorName}</strong> at <strong>{stats.longestTheaterTime.hospitalName}</strong>.
                                        </p>
                                    </div>
                                </div>
                            )}

                        </main>
                    </div>

                    {isEditing && (
                        <footer className="fixed bottom-0 left-0 right-0 bg-[#123133]/90 backdrop-blur-sm p-4 border-t border-[#255356]">
                            <div className="max-w-xl mx-auto flex justify-center space-x-2">
                                <button
                                    onClick={triggerStatsImport}
                                    className="flex items-center justify-center px-4 py-3 bg-[#246364] hover:bg-[#1e5051] text-white font-semibold rounded-lg shadow-md w-full"
                                >
                                    <ImportIcon />
                                    <span className="ml-2">Import</span>
                                </button>
                                <input
                                    type="file"
                                    ref={importStatsRef}
                                    onChange={handleImportStats}
                                    className="hidden"
                                    accept=".json,application/json"
                                />
                                <button
                                    onClick={handleExportStats}
                                    className="flex items-center justify-center px-4 py-3 bg-[#2F855A] hover:bg-[#276c4a] text-white font-semibold rounded-lg shadow-md w-full"
                                >
                                    <ExportIcon />
                                    <span className="ml-2">Export</span>
                                </button>
                                <button
                                    onClick={handleOpenClearConfirm}
                                    className="flex items-center justify-center px-4 py-3 bg-[#E53E3E] hover:bg-[#C53030] text-white font-semibold rounded-lg shadow-md w-full"
                                >
                                    <TrashIcon />
                                    <span className="ml-2">Clear</span>
                                </button>
                            </div>
                        </footer>
                    )}
                    
                    {isConfirmClearOpen && (
                        <ConfirmModal
                            title="Confirm Clear Stats"
                            message="Are you sure you want to proceed? You will be able to select which stats to clear."
                            onConfirm={handleProceedToSelect}
                            onClose={() => setIsConfirmClearOpen(false)}
                        />
                    )}
                    
                    {isSelectClearOpen && (
                        <ClearStatsModal
                            onClose={() => setIsSelectClearOpen(false)}
                            onConfirm={handleConfirmClear}
                            selections={selectionsToClear}
                            onSelectionChange={setSelectionsToClear}
                            statCategories={statCategories}
                        />
                    )}
                </div>
            );
        };


        // --- From App.tsx ---
        const App = () => {
            const { useState, useRef, useCallback, useEffect } = React;
            const LOCAL_STORAGE_KEY = 'patientDataManagerData';
            const STATS_STORAGE_KEY = 'patientDataStats';

            const [view, setView] = useState('main'); // 'main' or 'stats'
            const [isStatsEditing, setIsStatsEditing] = useState(false);

            const [allPatientData, setAllPatientData] = useState(() => {
                try {
                    const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                    return savedData ? JSON.parse(savedData) : [];
                } catch (error) {
                    console.error("Failed to load patient data from local storage", error);
                    return [];
                }
            });

            const [statsData, setStatsData] = useState(() => {
                try {
                    const savedStats = localStorage.getItem(STATS_STORAGE_KEY);
                    if (savedStats) {
                        const parsed = JSON.parse(savedStats);
                        // Ensure new stats keys exist
                        return { ...initialStatsData, ...parsed };
                    }
                    return { ...initialStatsData };
                } catch (error) {
                    console.error("Failed to load stats data from local storage", error);
                    return { ...initialStatsData };
                }
            });

            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);
            const [isExportModalOpen, setIsExportModalOpen] = useState(false);
            const [isConfirmModalOpen, setIsConfirmModalOpen] = useState(false);
            const [selectionsToDelete, setSelectionsToDelete] = useState({});
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            const fileInputRef = useRef(null);

            useEffect(() => {
                // Service Worker, Install Prompt, etc. (omitted for brevity, no changes)
            }, []);
            
            useEffect(() => {
                try {
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allPatientData));
                } catch (error) {
                    console.error("Failed to save patient data to local storage", error);
                }
            }, [allPatientData]);

            useEffect(() => {
                try {
                    localStorage.setItem(STATS_STORAGE_KEY, JSON.stringify(statsData));
                } catch (error) {
                    console.error("Failed to save stats data to local storage", error);
                }
            }, [statsData]);
            
            const handleInstallClick = async () => { /* ... no change ... */ };

            const handleFileImport = async (event) => {
                const file = event.target.files?.[0];
                if (!file) return;

                setIsLoading(true);
                setError(null);
                try {
                    const data = await parsePatientData(file);
                    if (data.patients.length === 0) {
                      setError("No patient data found in the file. Please check the format.");
                    } else {
                      const sectionWithId = { ...data, id: `section-${Date.now()}-${Math.random()}` };
                      setAllPatientData(prevData => [...prevData, sectionWithId]);
                    }
                } catch (err) {
                    console.error(err);
                    setError('Failed to parse the file. Please ensure it is a valid XLSX file with the correct format.');
                } finally {
                    setIsLoading(false);
                    if (fileInputRef.current) {
                        fileInputRef.current.value = '';
                    }
                }
            };

            const updateStats = (section) => {
                setStatsData(prevStats => {
                    const newStats = JSON.parse(JSON.stringify(prevStats));
                    // Ensure new stats keys exist on old data structure
                    if (!newStats.ageStats) newStats.ageStats = { over70: 0, under70: 0, oldestPatient: null };
                    if (!newStats.longestTheaterTime) newStats.longestTheaterTime = null;

                    const { sectionHeader, patients } = section;
                    
                    const headerParts = sectionHeader.split(',').map(s => s.trim());
                    const doctorName = headerParts[0] || section.doctorName || 'Unknown Doctor';
                    const hospitalName = headerParts.length > 1 ? headerParts[1] : (section.hospitalName || 'Unknown Hospital');

                    newStats.totalPatients += patients.length;

                    patients.forEach(patient => {
                        // Standard stats
                        newStats.patientsByDoctor[doctorName] = (newStats.patientsByDoctor[doctorName] || 0) + 1;
                        newStats.patientsByHospital[hospitalName] = (newStats.patientsByHospital[hospitalName] || 0) + 1;
                        newStats.sedationTypes[patient.sedationType] = (newStats.sedationTypes[patient.sedationType] || 0) + 1;

                        // Age stats
                        const age = parseInt(patient.age, 10);
                        if (!isNaN(age)) {
                            if (age > 70) {
                                newStats.ageStats.over70 += 1;
                            } else if (age < 70) {
                                newStats.ageStats.under70 += 1;
                            }
                            if (!newStats.ageStats.oldestPatient || age > (parseInt(newStats.ageStats.oldestPatient.age, 10) || 0)) {
                                newStats.ageStats.oldestPatient = {
                                    patientName: patient.name,
                                    age: patient.age,
                                    doctorName,
                                    hospitalName,
                                    procedure: patient.procedure,
                                    date: new Date().toISOString().split('T')[0],
                                };
                            }
                        }

                        // BMI stats
                        const bmi = calculateBmi(patient.weight, patient.height);
                        if (bmi !== null) {
                            if (bmi >= 35) {
                                newStats.bmiStats.over35 += 1;
                            } else {
                                newStats.bmiStats.under35 += 1;
                            }
                            if (!newStats.bmiStats.highestBmi || bmi > newStats.bmiStats.highestBmi.bmi) {
                                newStats.bmiStats.highestBmi = {
                                    patientName: patient.name,
                                    doctorName,
                                    hospitalName,
                                    date: new Date().toISOString().split('T')[0],
                                    bmi,
                                    procedure: patient.procedure,
                                };
                            }
                        }

                        // Theater time stats
                        const inTimeMinutes = parseTime(patient.inTime);
                        const outTimeMinutes = parseTime(patient.outTime);
                        if (inTimeMinutes !== null && outTimeMinutes !== null) {
                            let duration = outTimeMinutes - inTimeMinutes;
                            if (duration < 0) duration += 24 * 60; // Handles overnight

                            if (!newStats.longestTheaterTime || duration > newStats.longestTheaterTime.duration) {
                                newStats.longestTheaterTime = {
                                    patientName: patient.name,
                                    doctorName,
                                    hospitalName,
                                    date: new Date().toISOString().split('T')[0],
                                    procedure: patient.procedure,
                                    duration,
                                };
                            }
                        }
                    });
                    return newStats;
                });
            };

            const performExport = (section) => {
                const fileName = `${section.sectionHeader.replace(/, /g, '_') || 'pain_data'}.xlsx`;
                try {
                    exportPatientData(section.patients, fileName);
                    updateStats(section); // This is the new hook
                } catch (err) {
                    console.error(err);
                    setError('Failed to export data.');
                }
            };

            const handleExport = () => {
                if (!allPatientData || allPatientData.length === 0) {
                    alert('No patient data to export.');
                    return;
                }
                
                if (allPatientData.length === 1) {
                    performExport(allPatientData[0]);
                } else {
                    setIsExportModalOpen(true);
                }
            };
            
            const handleSelectAndExport = (section) => {
                performExport(section);
                setIsExportModalOpen(false);
            };

            const handlePatientUpdate = useCallback((updatedPatient) => {
                setAllPatientData(currentAllData =>
                    currentAllData.map(section => ({
                        ...section,
                        patients: section.patients.map(p =>
                            p.id === updatedPatient.id ? updatedPatient : p
                        ),
                    }))
                );
            }, []);

            const handleSectionHeaderChange = useCallback((sectionId, newHeader) => {
                setAllPatientData(currentAllData =>
                    currentAllData.map(section => {
                        if (section.id === sectionId) {
                            return { ...section, sectionHeader: newHeader };
                        }
                        return section;
                    })
                );
            }, []);

            const handleClearAll = () => {
                const initialSelections = {};
                allPatientData.forEach((_, index) => {
                    initialSelections[index] = true;
                });
                setSelectionsToDelete(initialSelections);
                setIsConfirmModalOpen(true);
            };

            const performDeletion = () => {
                setAllPatientData(currentData => 
                    currentData.filter((_, index) => !selectionsToDelete[index])
                );
                setIsConfirmModalOpen(false);
                setSelectionsToDelete({});
            };
            
            const triggerFileInput = () => {
                fileInputRef.current?.click();
            };
            
            if (view === 'stats') {
                return <StatsPage stats={statsData} setStats={setStatsData} onBack={() => setView('main')} isEditing={isStatsEditing} setIsEditing={setIsStatsEditing} />;
            }
            
            let cumulativePatientCount = 0;

            return (
                <div className="min-h-screen bg-[#003638] text-[#EAEFF0] font-sans">
                    <div className="max-w-md mx-auto p-4">
                         <header className="py-4 relative">
                            <img src="cropped.png" alt="Pain app logo" className="mx-auto w-48 h-48" width="192" height="192" />
                            <button onClick={() => setView('stats')} className="absolute top-4 right-0 p-2 text-white hover:text-[#66d1cc] rounded-md hover:bg-[#255356]" aria-label="Open Statistics">
                                <BurgerMenuIcon />
                            </button>
                        </header>

                        <main className="mt-6 space-y-6">
                            {isLoading && <p className="text-center text-lg text-[#66d1cc]">Processing file...</p>}
                            {error && <p className="text-center text-lg text-[#F56565] bg-red-500/20 p-3 rounded-lg">{error}</p>}
                            
                            {!isLoading && allPatientData.length === 0 && !error && (
                                <div className="text-center text-[#B8C0C1] mt-16 p-6 bg-[#184144] rounded-lg">
                                    <p className="text-xl">Welcome!</p>
                                    <p>Click "Import" to load patient data.</p>
                                </div>
                            )}

                            {allPatientData.map((patientData, index) => {
                                if (patientData.patients.length === 0) {
                                    return null;
                                }
                                
                                const startingIndex = cumulativePatientCount;
                                cumulativePatientCount += patientData.patients.length;

                                return (
                                    <div key={patientData.id} className="bg-black/20 rounded-lg shadow-lg overflow-hidden border border-[#255356]">
                                         <input
                                            type="text"
                                            value={patientData.sectionHeader}
                                            onChange={(e) => handleSectionHeaderChange(patientData.id, e.target.value)}
                                            className="w-full p-4 text-xl font-bold text-center text-white bg-[#184144] border-0 focus:ring-2 focus:ring-inset focus:ring-[#246364] focus:outline-none"
                                            aria-label="Editable section header"
                                            placeholder="Section Header"
                                         />
                                        <div className="p-4 space-y-3">
                                            {patientData.patients.map((patient, patientIndex) => (
                                                <PatientAccordion
                                                    key={patient.id}
                                                    patient={patient}
                                                    patientNumber={startingIndex + patientIndex + 1}
                                                    onUpdate={handlePatientUpdate}
                                                />
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}
                        </main>
                        
                        <footer className="mt-8 pt-6 border-t border-[#255356]">
                            <div className="flex justify-center space-x-2 flex-wrap gap-2">
                                <button
                                    onClick={triggerFileInput}
                                    className="flex items-center justify-center px-4 py-3 bg-[#246364] hover:bg-[#1e5051] text-white font-semibold rounded-lg shadow-md transition-transform transform hover:scale-105"
                                    aria-label="Import XLSX file"
                                >
                                    <ImportIcon />
                                    <span className="ml-2 hidden sm:inline">Import</span>
                                </button>
                                <input
                                    type="file"
                                    ref={fileInputRef}
                                    onChange={handleFileImport}
                                    className="hidden"
                                    accept=".xlsx"
                                />
                                <button
                                    onClick={handleExport}
                                    disabled={allPatientData.length === 0}
                                    className="flex items-center justify-center px-4 py-3 bg-[#2F855A] hover:bg-[#276c4a] text-white font-semibold rounded-lg shadow-md transition-transform transform hover:scale-105 disabled:bg-[#4a6566] disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                                    aria-label="Export data to XLSX file"
                                >
                                    <ExportIcon />
                                    <span className="ml-2 hidden sm:inline">Export</span>
                                </button>
                                <button
                                    onClick={handleClearAll}
                                    disabled={allPatientData.length === 0}
                                    className="flex items-center justify-center px-4 py-3 bg-[#E53E3E] hover:bg-[#C53030] text-white font-semibold rounded-lg shadow-md transition-transform transform hover:scale-105 disabled:bg-[#4a6566] disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                                    aria-label="Clear all data"
                                >
                                    <TrashIcon />
                                    <span className="ml-2 hidden sm:inline">Clear All</span>
                                </button>
                                {deferredPrompt && (
                                    <button
                                        onClick={handleInstallClick}
                                        className="flex items-center justify-center px-4 py-3 bg-[#6B46C1] hover:bg-[#553C9A] text-white font-semibold rounded-lg shadow-md transition-transform transform hover:scale-105"
                                        aria-label="Install application"
                                    >
                                        <InstallIcon />
                                        <span className="ml-2 hidden sm:inline">Install App</span>
                                    </button>
                                )}
                            </div>
                        </footer>
                    </div>
                    
                    {isExportModalOpen && (
                        <ExportModal
                            sections={allPatientData}
                            onSelect={handleSelectAndExport}
                            onClose={() => setIsExportModalOpen(false)}
                        />
                    )}
                    {isConfirmModalOpen && (
                        <ConfirmModal
                            title="Confirm Deletion"
                            sections={allPatientData}
                            selections={selectionsToDelete}
                            onSelectionChange={setSelectionsToDelete}
                            onConfirm={performDeletion}
                            onClose={() => setIsConfirmModalOpen(false)}
                        />
                    )}
                </div>
            );
        };

        // --- From index.tsx ---
        const rootElement = document.getElementById('root');
        if (!rootElement) {
          throw new Error("Could not find root element to mount to");
        }

        const root = ReactDOM.createRoot(rootElement);
        root.render(
          <React.StrictMode>
            <App />
          </React.StrictMode>
        );
    </script>
</body>
</html>
